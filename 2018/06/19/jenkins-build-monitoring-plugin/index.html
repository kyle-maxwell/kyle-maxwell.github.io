<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>A build monitoring plugin for Jenkins — GoDaddy Engineering Blog</title>
  <meta name="description" content="Information from our engineering team about the technology and tools we use to create software which empowers small businesses around the world to build and market their digital identities.
">

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link rel="stylesheet" href="/engineering/assets/css/main.css">

  <meta name="theme-color" content="#4095e8">
  <meta name="msapplication-TileColor" content="#4095e8">
  <link rel="apple-touch-icon" sizes="180x180" href="/engineering/assets/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/engineering/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/engineering/assets/images/favicon-16x16.png">
  <link rel="manifest" href="/engineering/site.webmanifest">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/engineering/feed.xml" title="GoDaddy Engineering Blog" />

  
  <link rel="canonical" href="http://localhost:4000/2018/06/19/jenkins-build-monitoring-plugin/">
  

  <meta property="og:locale" content="en_US">
  <meta property="og:site_name" content="GoDaddy Engineering Blog">
  <meta property="og:url" content="http://localhost:4000/2018/06/19/jenkins-build-monitoring-plugin/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@GodaddyOSS">

  
  <meta property="og:image" content="http://localhost:4000/assets/images/jenkmagic.png">
  

  
  <meta property="og:title" content="A build monitoring plugin for Jenkins — GoDaddy Engineering Blog">
  

  
  <meta property="og:description" content="We recently built a plugin to automatically monitor the health of our Jenkins builds. This article talks about how and why the plugin was built, and describes how it works at a high level.">
  

  <link rel="preload" href="//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: Boing-Bold;
    src: url(//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff) format("woff");
    font-display: swap;
  }
  </style>
  <link rel="preload" href="//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: gdsherpa;
    src: url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff) format("woff");
    font-weight: 700;
    font-display: swap;
  }
  </style>
  <link rel="preload" href="//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: gdsherpa;
    src: url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff) format("woff");
    font-display: swap;
  }
  </style>
</head>

  <body class="layout--post page--jenkins-build-monitoring-plugin">
    <nav class="navbar utility-bar navbar-dark bg-theme-grey-dark px-3 py-0">
  <a class="navbar-brand pt-1 pb-0" href="https://www.godaddy.com">
    <svg class="logo-mark logo-mark-white" height="18" viewBox="0 0 367.7 78.1" xmlns="http://www.w3.org/2000/svg"><path class="logo-mark-color" d="M95.3 38.6c0-4.6-3.6-8.4-8.3-8.4-4.6 0-8.3 3.8-8.3 8.4s3.6 8.3 8.3 8.3 8.3-3.7 8.3-8.3m14.4.1c0 11.9-10.1 21.4-22.6 21.4-12.6 0-22.6-9.5-22.6-21.4 0-12 10.1-21.6 22.6-21.6 12.5-.1 22.6 9.6 22.6 21.6M154.8 30c0-8-5.6-15-13.9-15h-11.5v30.3h11.5c8.3 0 13.9-7.3 13.9-15.3m15.5 0c0 17.1-12.1 28.8-29.1 28.8h-24.6c-1.2 0-2.1-.9-2.1-2V3.4c0-1.1.9-2 2.1-2h24.6c17.1.1 29.1 11.5 29.1 28.6M194.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4 0 4.7 3.7 8.4 8.3 8.4M192.2 17c4.9 0 8.8 1.8 10.5 4.3v-1.2c0-1.1.9-1.9 1.9-1.9H215c1.1 0 1.9.8 1.9 1.9v36.8c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-1.7 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6s10-21.4 20.4-21.4M241.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4 0 4.7 3.7 8.4 8.3 8.4M238.9 17c5 0 8.9 1.9 10.7 4.1V3.4c0-1.1.9-1.9 1.9-1.9H262c1.1 0 1.9.8 1.9 1.9V57c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-2.1 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6S228.7 17 238.9 17M288.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4.1 4.7 3.7 8.4 8.3 8.4M286 17c5 0 8.9 1.9 10.7 4.1V3.4c0-1.1.9-1.9 1.9-1.9H309c1.1 0 1.9.8 1.9 1.9V57c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-2.1 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6S275.7 17 286 17M345.5 64.7c-2.6 8.6-8.6 13.4-18 13.4-5.1 0-10.1-1.7-13.3-4.5-.5-.5-.8-1.1-.8-1.7 0-.5.2-1.1.7-1.7l3.9-5.9c.6-.8 1.5-.9 1.7-.9.9 0 1.3.2 2.1.8 1.2.8 2.9 1.8 4.8 1.8 1.6 0 3.7-.7 4.5-3.1l1.3-4.1H326c-1.3 0-2.1-.9-2.5-2L313 21.5c-.2-.9-.3-1.4-.3-1.7 0-.8.6-1.5 1.7-1.5h12.4c1.1 0 1.7 1 2 2l6.9 25.4h.5l5.5-25.4c.2-1 .9-2 2-2h12.6c1.2 0 1.7.7 1.7 1.5 0 .3-.1.8-.3 1.7l-12.2 43.2M49.7 50.9c-5 6.9-13.2 9.2-20.5 9.2C12.4 60.1 0 47.6 0 30.2.1 13.5 13.5.2 31 .2c13 0 23.4 5.5 28.1 16 .6 1.2 1 3.2-2.5 3.8l-9.2 1.6c-2.1.4-3.3-1-3.7-1.6-2.7-3.7-7.1-6.2-12.4-6.2-9.2 0-15.7 7-15.7 16.3 0 10.3 7.4 16.3 15.5 16.3 5.4 0 9.8-2 12.7-5.8h-8.1c-1.2 0-2.1-.9-2.1-2v-7.7c0-1.1.9-2 2.1-2h24.7c1.2 0 2.1.9 2.1 2v25.9c0 1.1-.9 2-2.1 2h-8.6c-1.2 0-2.1-.9-2.1-2v-5.9M359.8 0c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14.4c-3.5 0-6.4-2.9-6.4-6.4s2.9-6.4 6.4-6.4 6.4 2.9 6.4 6.4-2.9 6.4-6.4 6.4z"></path><path class="logo-mark-color" d="M361.4 6.5c0-.4-.1-.7-.4-.8-.2-.2-.6-.4-.9-.4h-1.4v2.3h1.4c.4 0 .7-.1.9-.4.2-.2.4-.4.4-.7zm-3.1 5.9h-1.5c-.1 0-.1 0-.2-.1 0-.1-.1-.1-.1-.2V3.8c0-.1 0-.1.1-.2.1 0 .1-.1.2-.1h3.3c1.1 0 1.9.2 2.5.8s.9 1.3.9 2.1c0 .6-.1 1.1-.5 1.5-.4.5-.7.8-1.2 1.1l1.9 2.9c.1.1.1.2 0 .4 0 .1-.1.1-.2.1H362c-.1 0-.2 0-.4-.1-.1 0-.1-.1-.2-.2l-1.6-2.7h-1.2V12c0 .1 0 .1-.1.2s-.1.2-.2.2z"></path></svg>
    &nbsp;
  </a>
</nav>

<nav class="navbar navbar-top navbar-expand-md navbar-light bg-white">
  <a class="navbar-brand font-weight-bold" href="http://localhost:4000/engineering/" title="GoDaddy Engineering">
    GoDaddy Engineering
  </a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#topnav" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="topnav">
    <ul class="navbar-nav ml-auto">
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/featured-projects/" title="Featured Projects">
          Featured Projects
        </a>
      </li>
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/blog-posts/" title="Blog Posts">
          Blog Posts
        </a>
      </li>
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/code-of-conduct/" title="Code of Conduct">
          Code of Conduct
        </a>
      </li>
      
      
      <li class="nav-item">
        <a class="nav-link btn btn-primary text-white font-weight-bold px-3" href="https://careers.godaddy.com/?source=APPLICANT_SOURCE-3-118&utm_source=godaddy-oss" title="Work at GoDaddy">
          Join us!
        </a>
      </li
    </ul>
  </div>
</nav>





<div class="container text-line-height-2x pt-3">
  <h1 class="mb-3 text-line-height-1-5-em">
    A build monitoring plugin for Jenkins
  </h1>

  <p>I recently wrote about some of the <a href="/2018/06/05/cicd-best-practices/">Jenkins CICD best practices</a>
we use on my team at GoDaddy. One of the best practices was:</p>

<p><strong>You should use declarative pipeline</strong>.</p>

<p>Most of our pipelines provide per-stage status checks shown on
the GitHub PR page. For example:</p>

<p><img src="/engineering/assets/images/monitoring-plugin/pr-build-page.png" alt="PR Page showing status checks" /></p>

<p>Our engineers like this because they don’t have to leave GitHub so see whether the PR built successfully.</p>

<p>We used a shared Groovy library that provides support for sending a “Pending”
status when a stage begins, and “Success” or “Error” when the stage completes.
While converting our first jobs to declarative pipeline, we encountered a common script
pattern for this which proved to be difficult to convert to declarative pipeline
cleanly.</p>

<p>For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import org.godaddy.CommitStatus;

gdnode {
  def lintTestStatus = new CommitStatus(
    [description: 'Running linters',
     context: 'Linters',
     credentialsId: 'xxxxxxxxxx',
     workflow: this]);
  def unitTestStatus = new CommitStatus(
    [description: 'Running unit tests',
     context: 'Unit tests',
     credentialsId: 'xxxxxxxxxx',
     workflow: this]);
  def integrationTestStatus = new CommitStatus(
    [description: 'Running integration tests',
     context: 'Integration tests',
     credentialsId: 'xxxxxxxxxx',
     workflow: this]);
  def functionalTestStatus = new CommitStatus(
    [description: 'Running functional tests',
     context: 'Functional tests',
     credentialsId: 'xxxxxxxxxx',
     workflow: this]);

  CommitStatus.with([lintTestStatus, unitTestStatus, integrationTestStatus, functionalTestStatus]) {
    pipeline(
      [lintTest: lintTestStatus,
       unitTest: unitTestStatus,
       integrationTest: integrationTestStatus,
       functionalTest: functionalTestStatus])
  }
}
...
void pipeline(statuses) {
  def dockerTag = env.DOCKER_BUILD_TAG;
  def shortSha = env.GIT_SHORT_COMMIT;

...

  stage('npm run eslint') {
    sh 'docker run --rm ' +
      '-e APP_GROUP_ID=$(id -g) ' +
      '-e APP_USER_ID=$(id -u) ' +
      "${dockerTag} npm run eslint"
  }
  statuses.lintTest.set('success');

  stage('npm test') {
    sh 'docker run --rm -v $(pwd)/results:/app/results ' +
      '-e APP_GROUP_ID=$(id -g) ' +
      '-e APP_USER_ID=$(id -u) ' +
      "${dockerTag} gosu alone npm test -- -R xunit --reporter-options output=results/unit.xml"
      step([$class: 'JUnitResultArchiver', testResults: 'results/unit.xml'])
  }
  statuses.unitTest.set('success');
</code></pre></div></div>

<p>We could have used inline script (provided for backward compatibility with traditional
scripted pipeline), but we would have missed a lot of the benefit of switching to
declarative pipeline script.</p>

<h2 id="a-new-plugin-is-born">A new plugin is born</h2>

<p>There are already a few Jenkins plugins which can report GitHub status, but the ones we found
rely on the pipeline self-reporting status information, similar to our groovy library. These plugins
still require adding at least two lines of groovy in the Jenkinsfile to work the way we wanted -
one to mark the check as <em>Pending</em> when a stage starts, and another to mark it as <em>Succeeded</em> or <em>Failed</em> when the stage ends.</p>

<p>We decided we could simplify our pipelines even more (and eliminate possible bugs) by writing a
plugin which didn’t require <em>any</em> groovy in the Jenkinsfile to report status. The <a href="https://jenkins.io/doc/developer/extensions/workflow-api/#graphlistener">GraphListener extension point</a>, which a plugin can implement to be called whenever any stage or step
starts or ends seemed like it could be used for monitoring, and indeed we were able to use it to write the
first version of the <a href="https://plugins.jenkins.io/GitHub-autostatus">GitHub Autostatus plugin</a>, which provided <em>Pending</em> and <em>Success</em> or <em>Error</em> notifications as stages were started and stopped.
Since we were only trying
to solve the immediate problem of declarative pipelines, this version only supported declarative pipeline. This
was a nice simplification, since declarative pipelines offer a data model that lets a plugin enumerate all the stages in a pipeline; this takes a little more work for classic scripted pipeline.</p>

<h2 id="a-new-problem">A new problem</h2>

<p>One of our main pipelines builds Web, Android, and iOS applications from a common javascript code base, using React for the web and React Native for mobile.
We went through a period recently where the build failed so often that our engineers could barely merge any changes.
The problem was we didn’t have enough data to know which part(s) of the pipeline failed the most often,
so it was hard to prioritize where to focus the most effort.</p>

<p>That’s when we realized that the GitHub autostatus plugin was very close to solving the problem.
It already provided per-stage information, so all it needed to do was provide that same information to a second
source, and we’d have dashboards for our builds.</p>

<p>We decided to initially use Grafana for the dashboards, using InfluxDB as the database. Although there were a variety of options available, we chose this configuration for the following reasons:</p>
<ul>
  <li>It has a very simple REST API which can be called easily from Jenkins</li>
  <li>It’s relatively easy to set up instances, including locally which is helpful for development</li>
  <li>Grafana has some nice templating features which allow you to use a query to build multiple similar copies of a graph. For example, instead of building graphs for each GitHub repo being monitored, you can build a set of graphs for one repo as a template, then use a query as a template to copy that set for some or all repos you have data on.</li>
  <li>You can host sample dashboards on grafana.com, making it easier for people to use the plugin</li>
</ul>

<p>There are other good options, and it’s likely the plugin will be extended to support others in the future.</p>

<p>In the rest of this article, I’ll talk about the high-level design of the plugin, then provide some pointers for configuring it.</p>

<h2 id="high-level-design">High-level design</h2>

<p>The following class diagram shows the architecture of the plugin.</p>

<p><img src="/engineering/assets/images/monitoring-plugin/github-autostatus-design.png" alt="GitHub autostatus plugin class diagram" /></p>

<h3 id="job-watching-components">Job watching components</h3>

<h4 id="githubbuildstatusgraphlistener">GitHubBuildStatusGraphListener</h4>

<p>The <strong>GitHubBuildStatusGraphListener</strong> class is responsible for:</p>
<ul>
  <li>Creating a BuildStatusAction and attaching it to the build. This class is responsible for sending the actual notifications</li>
  <li>Determining when stages start and end</li>
  <li>Sending pending notifications for each stage via the BuildStatusAction instance attached to the build</li>
  <li>Sending success or error notifications with timing via the BuildStatusAction instance attached to the build when a stage completed</li>
</ul>

<p>It receives notifications via the <a href="http://javadoc.jenkins.io/plugin/workflow-api/org/jenkinsci/plugins/workflow/flow/GraphListener.html">GraphListener</a> interface. Plugins which correctly implement the interface get called via the interface’s <code class="highlighter-rouge">onNewHead(flowNode)</code> method for each FlowNode. FlowNodes represent the start and end of blocks and atom nodes (individual steps which can’t be broken down further).</p>

<h5 id="flow-node-example">Flow node example</h5>

<p>One of the easiest ways to visualize the calls made to the GraphListener extension is by
examining Jenkins’ <strong>Pipeline Steps</strong> build action, which is available from the build
page for every pipeline build.</p>

<p>This build action provides UI which lists all BlockStartNode and AtomStepNode flow nodes
(but not BlockEndNode); each line on that page should have a corresponding call
to the plugin’s <code class="highlighter-rouge">GraphListener.onNewHead()</code>.</p>

<p>Consider the following declarative pipeline script:</p>
<div class="language-groovy highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pipeline</span> <span class="o">{</span>
  <span class="n">agent</span> <span class="n">any</span>
  <span class="n">stages</span> <span class="o">{</span>
    <span class="n">stage</span> <span class="o">(</span><span class="s1">'stage 1'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s1">'echo stage 1 step 1'</span>
      <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">stage</span> <span class="o">(</span><span class="s1">'stage 2'</span><span class="o">)</span> <span class="o">{</span>
      <span class="n">steps</span> <span class="o">{</span>
        <span class="n">sh</span> <span class="s1">'echo stage 2 step 1'</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <strong>Pipeline Steps</strong> build action links to this page:</p>

<p><img src="/engineering/assets/images/monitoring-plugin/flowgraph-table.png" alt="Pipeline steps" /></p>

<p>You can see representations for every stage and step in the plugin, plus additional stuff added by Jenkins automatically.</p>

<p><code class="highlighter-rouge">onNewHead(flowNode)</code> is called with the following flowNodes.</p>

<p><img src="/engineering/assets/images/monitoring-plugin/flownode-table.png" alt="Flownodes" /></p>

<p>StepStartNode Flow nodes contain additional properties to help identify their purpose,
but that’s enough detail for this example.</p>

<p><code class="highlighter-rouge">onNewHead(flowNode)</code>’s (simplified) algorithm is:</p>
<ul>
  <li>Get or create a BuildStatusAction (See [1] below)</li>
  <li>Add a new stage to the BuildStatusAction for non-declarative jobs</li>
  <li>Check any StepAtomNodes for an out of stage error (See [2] below)</li>
  <li>If a StepEndNode’s display name matches any stage, send stage status notification to all notifiers via the BuildStatusAction.</li>
</ul>

<p><strong>Notes</strong></p>
<ol>
  <li>If the code is processing a declarative pipeline job, it creates information for each stage and sends Pending notifications at the same time it creates the BuildStatusAction. It can do this because the <strong>Declarative Pipeline</strong> plugin provides a model that enumerates the stages. Since classic pipeline doesn’t do that, each stage is discovered when it starts; the code handles both cases.</li>
  <li>Out of stage error only applies to classic pipeline. Since the structure is very loose, it’s possible to code a step that is outside of a stage. Without special processing to detect that scenario, errors in that step would be missed.</li>
</ol>

<h4 id="buildstatusjoblistener">BuildStatusJobListener</h4>

<p>The <strong>BuildStatusJobListener</strong> class is responsible for sending job notifications when the build completes. Overall job notification includes build time and success or error status.</p>

<h3 id="job-notification-components">Job notification components</h3>

<p>All notifications are sent through the <strong>BuildStatusAction</strong> class. <a href="https://wiki.jenkins.io/display/JENKINS/Action+and+its+family+of+subtypes">Build action</a> is Jenkins extension mechanism which allows a plugin to attach information to a build. Originally intended to provide links (called build actions) on the build page, it’s become a general purposed mechanism that allows any plugin to associate information with a build - potentially permanently, as they get serialized along with the build by default.</p>

<p>The BuildStatusAction class keeps a list of all stages, so it can keep track of whether the final notification has been sent. It also keeps a list of notifiers, and provides an interface that can be called to send notifications to all notifiers.</p>

<h4 id="githubbuildnotifier">GitHubBuildNotifier</h4>

<p>This class is responsible for sending per-stage status information to GitHub if it’s configured to do so
in the plugin settings. It uses the <a href="http://GitHub-api.kohsuke.org/apidocs/org/kohsuke/GitHub/GHRepository.html">GHRepository</a> API.</p>

<h4 id="influxdbnotifer">InfluxDbNotifer</h4>

<p>This class is responsible for sending per-stage and job status information to a InfluxDB instance if
it’s configured to do so, using the <a href="https://docs.influxdata.com/influxdb/v1.5/guides/writing_data/">InfluxDB REST API</a>.</p>

<h3 id="configuration-components">Configuration components</h3>

<h4 id="buildstatusconfig">BuildStatusConfig</h4>

<p>BuildStatusConfig extends the <a href="http://javadoc.jenkins.io/jenkins/model/GlobalConfiguration.html">GlobalConfiguration class</a>, which allows it to provide
UI in the Jenkins system configuration page to configure the plugin.</p>

<h3 id="githubnotificationconfig-and-influxdbnotifierconfig">GitHubNotificationConfig and InfluxDbNotifierConfig</h3>

<p>Each type of notifier has matching configuration components which are responsible
for examining the global configuration to determine whether the notifier should
be enabled for the current build. Abstracting configuration away to separate classes
provides good separation of concerns; determining whether to provide GitHub status
in particular requires quite a bit logic. It also simplifies a lot of the unit tests,
since dependency injection can be used to provide fake configurations without setting up
a full build.</p>

<h2 id="reporting-with-influxdb-and-grafana">Reporting with InfluxDB and Grafana</h2>

<p><a href="https://docs.influxdata.com/influxdb/v1.5/">InfluxDB</a> is a time series
database that is available for free to run on a single node (there’s also a
paid Enterprise version). <a href="https://grafana.com/">Grafana</a> is an analytics
platform which allows you to build dashboards from time series databases, including
InfluxDB. It also has a free version which can be used for Jenkins monitoring.</p>

<p><a href="https://www.influxdata.com/time-series-database/">Time series databases</a>
are databases which are based on time stamped events. They are widely used for
monitoring, because they allow you to aggregate events based on different time ranges.
Although there are many good choices, we chose InfluxDB for the initial monitoring
implementation for the autostatus monitoring plugin.</p>

<h3 id="influxdb-schema">InfluxDB schema</h3>

<p>In InfluxDB, data is written to series, which are analogous to tables in a relational
database. Records in a series contain both <strong>tags</strong> and <strong>fields.</strong> Fields are
generally meant to be measurements which are aggregated, while tags are meant to be metadata.
As such, tags are indexed and can be queried efficiently, while fields are not.
Grafana does a good job of only allowing you to use the correct type while building
dashboards, but this is discussed in more detail in the <a href="https://docs.influxdata.com/influxdb/v1.5/concepts/key_concepts/">InfluxDB documentation</a>.</p>

<p>The plugin writes two different series:</p>
<ul>
  <li>the job series allows you to build dashboards that monitor timing and success rate for jobs</li>
  <li>the stage series provides success/failure information for each stage in every job, and allows you to build dashboards to monitor individual stages.</li>
</ul>

<p>In both cases, we want to measure build time and success/failure, so those need to be fields; everything else can be tags so they are indexed.</p>

<p><strong>Job Series Schema</strong></p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Tag/Field</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>owner</td>
      <td>Tag</td>
      <td>GitHub owner</td>
    </tr>
    <tr>
      <td>repo</td>
      <td>Tag</td>
      <td>GitHub repo</td>
    </tr>
    <tr>
      <td>branch</td>
      <td>Tag</td>
      <td>The name of the branch</td>
    </tr>
    <tr>
      <td>jobname</td>
      <td>Tag</td>
      <td>The full job name</td>
    </tr>
    <tr>
      <td>result</td>
      <td>Tag</td>
      <td>Queryable result</td>
    </tr>
    <tr>
      <td>jobtime</td>
      <td>Field Job elapsed time (ms)</td>
      <td> </td>
    </tr>
    <tr>
      <td>passed</td>
      <td>Field</td>
      <td>1 = passed, 0 - failed</td>
    </tr>
  </tbody>
</table>

<p><strong>Stage Series Schema</strong></p>

<table>
  <thead>
    <tr>
      <th>Name</th>
      <th>Tag/Field</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>owner</td>
      <td>Tag</td>
      <td>GitHub owner</td>
    </tr>
    <tr>
      <td>repo</td>
      <td>Tag</td>
      <td>GitHub repo</td>
    </tr>
    <tr>
      <td>branch</td>
      <td>Tag</td>
      <td>The name of the branch</td>
    </tr>
    <tr>
      <td>jobname</td>
      <td>Tag</td>
      <td>The full job name</td>
    </tr>
    <tr>
      <td>result</td>
      <td>Tag</td>
      <td>Queryable result</td>
    </tr>
    <tr>
      <td>stagename</td>
      <td>Tag</td>
      <td>Stage name</td>
    </tr>
    <tr>
      <td>stagetime</td>
      <td>Field</td>
      <td>Stage elapsed time (ms)</td>
    </tr>
    <tr>
      <td>passed</td>
      <td>Field</td>
      <td>1 = passed, 0 - failed</td>
    </tr>
  </tbody>
</table>

<p>Note that pass/success is represented twice. The <strong>passed</strong> fields can be used for
measurement, for example total failures, or average failures. The <strong>result</strong> tags
are indexed and so can be queried efficiently, for example select only measurements
where the job or staged failed. The result tag will have one of the following values:</p>
<ul>
  <li>CompletedSuccess</li>
  <li>CompletedError</li>
  <li>SkippedFailure (stage only)</li>
  <li>SkippedUnstable (stage only)</li>
  <li>SkippedConditional (stage only)</li>
</ul>

<h3 id="setting-up-dashboards">Setting up dashboards</h3>

<h4 id="install-grafana-and-influxdb">Install Grafana and InfluxDB</h4>

<p>If you don’t already have Grafana and InfluxDB:</p>
<ul>
  <li>Follow <a href="https://docs.influxdata.com/influxdb/v1.5/introduction/installation/">InfluxDB installation instructions</a></li>
  <li>Follow <a href="http://docs.grafana.org/installation/">Grafana installation instructions</a></li>
</ul>

<h4 id="configuring-influxdb">Configuring InfluxDB</h4>

<p>InfluxDB doesn’t have a UI, but you can configure it from the command line. To open the
InfluxDB console, type <code class="highlighter-rouge">influx</code>, which should open the InfluxDB console:</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>influx
Connected to http://localhost:8086 version v1.5.2
InfluxDB shell version: v1.5.3
&gt;
</code></pre></div></div>

<p>Follow the following steps in the console:</p>
<ol>
  <li>create a database <code class="highlighter-rouge">create database jekninsdb</code></li>
  <li>(optional) create a user so you can use authentication
    <ul>
      <li><code class="highlighter-rouge">use jenkinsdb</code></li>
      <li><code class="highlighter-rouge">create user jenkins with password 'password'</code> (<em>password</em> is a placeholder for the password you want to use)</li>
      <li><code class="highlighter-rouge">grant read on jenkinsdb to jenkins</code></li>
      <li><code class="highlighter-rouge">grant write on jenkinsdb to jenkins</code></li>
      <li>follow the instructions in the <a href="https://docs.influxdata.com/influxdb/v1.5/query_language/authentication_and_authorization/#user-management-commands">authentication documentation</a> for enabling authentication, as it is disabled by default</li>
    </ul>
  </li>
  <li>(optional) create a retention policy to define how long data is kept - by default it is kept forever. The amount of data written by the plugin is small, so this might be OK if you want a lot of historical data. For example, to keep data for a year, and dispose of 4 weeks’ worth of data at a time:
    <ul>
      <li><code class="highlighter-rouge">create retention policy autostatus on jenkinsdb duration 52w replication 1 shard duration 4w</code></li>
    </ul>
  </li>
</ol>

<p><strong>Note</strong> the retention policy is part of the namespace for querying; if you decide to add it
later you will need to migrate your existing data to the new retention policy, so it’s worth creating a retention policy
up front.</p>

<p>For additional configuration please consult - <a href="https://docs.influxdata.com/influxdb/v1.5/introduction/installation/">Configuring InfluxDB</a></p>

<h3 id="configuring-jenkins">Configuring Jenkins</h3>

<p>In order to send data to your dashboard, you’ll need to install and configure the plugin in Jenkins.</p>

<h4 id="installing-the-plugin">Installing the plugin</h4>

<p>The autostatus monitoring plugin is available via the Jenkins plugin manager. If it’s not installed
you can install it as follow:</p>
<ol>
  <li>Log in to Jenkins with an account with admin access</li>
  <li>Click the <code class="highlighter-rouge">Manage Jenkins</code> link at the top left</li>
  <li>Click the <code class="highlighter-rouge">Go to plugin manager</code> button or the <code class="highlighter-rouge">Manage Plugins</code> link to open the plugin manager</li>
  <li>Click the <code class="highlighter-rouge">Available</code> tab and find the <code class="highlighter-rouge">GitHub Autostatus Plugin</code>. <strong>Note</strong> the plugin will be renamed <code class="highlighter-rouge">Autostatus Build Monitoring Plugin</code> in the near future.</li>
  <li>Check the box next to it</li>
  <li>Click the <code class="highlighter-rouge">Install button</code></li>
  <li>Jenkins may or may not restart, depending on pending installations</li>
</ol>

<p>Please visit <a href="https://wiki.jenkins.io/display/JENKINS/GitHub+Autostatus+Plugin">the plugin wiki page</a>
for instructions about configuring the plugin and downloading sample dashboards from grafana.com.</p>

<h3 id="future-work">Future work</h3>

<p>Some of the things planned for the future include:</p>

<ul>
  <li>An Elastic Search notifier for building dashboards in Kibana</li>
  <li>Additional data, such as code overage information and test case pass/fail rate</li>
  <li>Exporting an extension point to build 3rd party notifiers. For example, some companies may already have a REST API for reporting; an extension point would allow them to write notifiers which send data to their REST API without needing to add support to the public plugin.</li>
</ul>

<h3 id="further-reading">Further reading</h3>

<ul>
  <li><a href="https://jenkins.io/doc/developer/extensions/">Comprehensive list of Jenkins extension points</a></li>
  <li><a href="https://plugins.jenkins.io/GitHub-autostatus">Autostatus monitoring plugin wiki page</a></li>
  <li><a href="https://GitHub.com/jenkinsci/GitHub-autostatus-plugin">Autostatus monitoring GitHub page</a></li>
  <li><a href="https://docs.influxdata.com/influxdb/v1.5/tools/shell/">InfluxDB CLI</a></li>
  <li><a href="https://docs.influxdata.com/influxdb/v1.5/query_language/authentication_and_authorization/">InfluxDB Authentication</a></li>
</ul>

<p>Note: cover photo courtesy of <a href="https://jenkins.io/">https://jenkins.io/</a></p>


  <div class="text-center mb-1">
  <div class="addthis_inline_share_toolbox"></div>
</div>

  

<hr>

<div class="authors">
  <h4 class="mb-3">
  
  Author
  
</h4>

  <div class="row">
    
    <div class="col-12">
      <div class="author mb-3">
        <a href="https://www.linkedin.com/in/jeffpea/">
          <img class="rounded mr-2" src="/engineering/assets/images/jxpearce.jpg" alt="Jeff Pearce" width="64">
          <span class="author-details">
            <h6>Jeff Pearce</h6>
            
          </span>
        </a>
      </div>
    </div>
    
  </div>
</div>

</div>

<footer class="page-footer text-light bg-theme-grey-dark">
    <div class="container py-3">
      <div class="row">
        <div class="col-12 col-md-6">
          <h5 class="text-white text-font-headline">
            GoDaddy Engineering
          </h5>
          <p>
            At GoDaddy we build next-generation experiences that empower the world's small business owners to start and grow their independent ventures.

            <a href="https://careers.godaddy.com/?source=APPLICANT_SOURCE-3-118&utm_source=godaddy-oss" title="Work at GoDaddy">
              Join us!
            </a>
          </p>
        </div>
        <div class="col-12 col-md-4 offset-md-2">
          <h5 class="text-white text-font-headline">
            On the web
          </h5>
          <ul class="list-unstyled mb-0">
  
  
  <li>
    <a class="text-light" href="https://github.com/godaddy" title="godaddy on GitHub">
      GitHub
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://twitter.com/GodaddyOSS" title="GodaddyOSS on Twitter">
      Twitter
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://dribbble.com/GoDaddy" title="GoDaddy on Dribbble">
      Dribbble
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://www.facebook.com/GoDaddy" title="GoDaddy on Facebook">
      Facebook
    </a>
  </li>
  
  
</ul>

        </div>
      </div>
    </div>
    <div class="footer-copyright bg-extra-dark text-center text-light font-weight-light py-3">
      <small>
        Copyright © 1999 - 2018 GoDaddy Operating Company, LLC. All Rights Reserved.

      </small>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>


<script async src="https://www.google-analytics.com/analytics.js"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js"></script>
<script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-37178807-20', 'auto');
  ga('require', 'outboundLinkTracker');
  ga('send', 'pageview');
</script>



<script async src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b039a09ed801a5d"></script>






</body>
</html>

