<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Making mocking mistakes in Python — GoDaddy Engineering Blog</title>
  <meta name="description" content="Information from our engineering team about the technology and tools we use to create software which empowers small businesses around the world to build and market their digital identities.
">

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link rel="stylesheet" href="/engineering/assets/css/main.css">

  <meta name="theme-color" content="#4095e8">
  <meta name="msapplication-TileColor" content="#4095e8">
  <link rel="apple-touch-icon" sizes="180x180" href="/engineering/assets/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/engineering/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/engineering/assets/images/favicon-16x16.png">
  <link rel="manifest" href="/engineering/site.webmanifest">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/engineering/feed.xml" title="GoDaddy Engineering Blog" />

  
  <link rel="canonical" href="http://localhost:4000/2018/09/04/python-mocking/">
  

  <meta property="og:locale" content="en_US">
  <meta property="og:site_name" content="GoDaddy Engineering Blog">
  <meta property="og:url" content="http://localhost:4000/2018/09/04/python-mocking/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@GodaddyOSS">

  
  <meta property="og:image" content="http://localhost:4000/assets/images/python-kitten.jpg">
  

  
  <meta property="og:title" content="Making mocking mistakes in Python — GoDaddy Engineering Blog">
  

  
  <meta property="og:description" content="Python mocking is tricky. See if you can diagnose and correct four example mocking mistakes, all of which I've made while learning the mock library in the past few months.">
  

  <link rel="preload" href="//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: Boing-Bold;
    src: url(//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff) format("woff");
    font-display: swap;
  }
  </style>
  <link rel="preload" href="//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: gdsherpa;
    src: url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff) format("woff");
    font-weight: 700;
    font-display: swap;
  }
  </style>
  <link rel="preload" href="//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: gdsherpa;
    src: url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff) format("woff");
    font-display: swap;
  }
  </style>
</head>

  <body class="layout--post page--python-mocking">
    <nav class="navbar utility-bar navbar-dark bg-theme-grey-dark px-3 py-0">
  <a class="navbar-brand pt-1 pb-0" href="https://www.godaddy.com">
    <svg class="logo-mark logo-mark-white" height="18" viewBox="0 0 367.7 78.1" xmlns="http://www.w3.org/2000/svg"><path class="logo-mark-color" d="M95.3 38.6c0-4.6-3.6-8.4-8.3-8.4-4.6 0-8.3 3.8-8.3 8.4s3.6 8.3 8.3 8.3 8.3-3.7 8.3-8.3m14.4.1c0 11.9-10.1 21.4-22.6 21.4-12.6 0-22.6-9.5-22.6-21.4 0-12 10.1-21.6 22.6-21.6 12.5-.1 22.6 9.6 22.6 21.6M154.8 30c0-8-5.6-15-13.9-15h-11.5v30.3h11.5c8.3 0 13.9-7.3 13.9-15.3m15.5 0c0 17.1-12.1 28.8-29.1 28.8h-24.6c-1.2 0-2.1-.9-2.1-2V3.4c0-1.1.9-2 2.1-2h24.6c17.1.1 29.1 11.5 29.1 28.6M194.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4 0 4.7 3.7 8.4 8.3 8.4M192.2 17c4.9 0 8.8 1.8 10.5 4.3v-1.2c0-1.1.9-1.9 1.9-1.9H215c1.1 0 1.9.8 1.9 1.9v36.8c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-1.7 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6s10-21.4 20.4-21.4M241.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4 0 4.7 3.7 8.4 8.3 8.4M238.9 17c5 0 8.9 1.9 10.7 4.1V3.4c0-1.1.9-1.9 1.9-1.9H262c1.1 0 1.9.8 1.9 1.9V57c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-2.1 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6S228.7 17 238.9 17M288.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4.1 4.7 3.7 8.4 8.3 8.4M286 17c5 0 8.9 1.9 10.7 4.1V3.4c0-1.1.9-1.9 1.9-1.9H309c1.1 0 1.9.8 1.9 1.9V57c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-2.1 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6S275.7 17 286 17M345.5 64.7c-2.6 8.6-8.6 13.4-18 13.4-5.1 0-10.1-1.7-13.3-4.5-.5-.5-.8-1.1-.8-1.7 0-.5.2-1.1.7-1.7l3.9-5.9c.6-.8 1.5-.9 1.7-.9.9 0 1.3.2 2.1.8 1.2.8 2.9 1.8 4.8 1.8 1.6 0 3.7-.7 4.5-3.1l1.3-4.1H326c-1.3 0-2.1-.9-2.5-2L313 21.5c-.2-.9-.3-1.4-.3-1.7 0-.8.6-1.5 1.7-1.5h12.4c1.1 0 1.7 1 2 2l6.9 25.4h.5l5.5-25.4c.2-1 .9-2 2-2h12.6c1.2 0 1.7.7 1.7 1.5 0 .3-.1.8-.3 1.7l-12.2 43.2M49.7 50.9c-5 6.9-13.2 9.2-20.5 9.2C12.4 60.1 0 47.6 0 30.2.1 13.5 13.5.2 31 .2c13 0 23.4 5.5 28.1 16 .6 1.2 1 3.2-2.5 3.8l-9.2 1.6c-2.1.4-3.3-1-3.7-1.6-2.7-3.7-7.1-6.2-12.4-6.2-9.2 0-15.7 7-15.7 16.3 0 10.3 7.4 16.3 15.5 16.3 5.4 0 9.8-2 12.7-5.8h-8.1c-1.2 0-2.1-.9-2.1-2v-7.7c0-1.1.9-2 2.1-2h24.7c1.2 0 2.1.9 2.1 2v25.9c0 1.1-.9 2-2.1 2h-8.6c-1.2 0-2.1-.9-2.1-2v-5.9M359.8 0c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14.4c-3.5 0-6.4-2.9-6.4-6.4s2.9-6.4 6.4-6.4 6.4 2.9 6.4 6.4-2.9 6.4-6.4 6.4z"></path><path class="logo-mark-color" d="M361.4 6.5c0-.4-.1-.7-.4-.8-.2-.2-.6-.4-.9-.4h-1.4v2.3h1.4c.4 0 .7-.1.9-.4.2-.2.4-.4.4-.7zm-3.1 5.9h-1.5c-.1 0-.1 0-.2-.1 0-.1-.1-.1-.1-.2V3.8c0-.1 0-.1.1-.2.1 0 .1-.1.2-.1h3.3c1.1 0 1.9.2 2.5.8s.9 1.3.9 2.1c0 .6-.1 1.1-.5 1.5-.4.5-.7.8-1.2 1.1l1.9 2.9c.1.1.1.2 0 .4 0 .1-.1.1-.2.1H362c-.1 0-.2 0-.4-.1-.1 0-.1-.1-.2-.2l-1.6-2.7h-1.2V12c0 .1 0 .1-.1.2s-.1.2-.2.2z"></path></svg>
    &nbsp;
  </a>
</nav>

<nav class="navbar navbar-top navbar-expand-md navbar-light bg-white">
  <a class="navbar-brand font-weight-bold" href="http://localhost:4000/engineering/" title="GoDaddy Engineering">
    GoDaddy Engineering
  </a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#topnav" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="topnav">
    <ul class="navbar-nav ml-auto">
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/featured-projects/" title="Featured Projects">
          Featured Projects
        </a>
      </li>
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/blog-posts/" title="Blog Posts">
          Blog Posts
        </a>
      </li>
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/code-of-conduct/" title="Code of Conduct">
          Code of Conduct
        </a>
      </li>
      
      
      <li class="nav-item">
        <a class="nav-link btn btn-primary text-white font-weight-bold px-3" href="https://careers.godaddy.com/?source=APPLICANT_SOURCE-3-118&utm_source=godaddy-oss" title="Work at GoDaddy">
          Join us!
        </a>
      </li
    </ul>
  </div>
</nav>





<div class="container text-line-height-2x pt-3">
  <h1 class="mb-3 text-line-height-1-5-em">
    Making mocking mistakes in Python
  </h1>

  <h3 id="backgroundrequirements">Background/requirements</h3>
<p>This post assumes you have some familiarity with python mocking and the <code class="highlighter-rouge">mock</code> library. If not, <a href="https://www.toptal.com/python/an-introduction-to-mocking-in-python">this intro by Naftuli Kay</a> and <a href="https://semaphoreci.com/community/tutorials/getting-started-with-mocking-in-python">this other intro by Amos Omondi</a> are great places to start; these articles are where I figured out most of the mistakes I’ve been making. I’m working in Python 2, which still has <code class="highlighter-rouge">mock</code> v 2.0.0 as its own library rather than part of <code class="highlighter-rouge">unittest</code>, but the mistakes below also apply for Python 3.</p>

<hr />

<h3 id="example-mistake-1">Example mistake 1</h3>

<p>For the first example, let’s say we’re testing a function <code class="highlighter-rouge">is_cat_person</code>, within the module <code class="highlighter-rouge">main.py</code>. The function loads some json from a file using <code class="highlighter-rouge">json.load</code> and decides whether or not the person represented by the json is a Cat Person:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># main.py</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">is_cat_person</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">person_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="c"># Do some stuff with person_json and return True if Cat Person, False otherwise</span>
</code></pre></div></div>

<p>We want to test the function, but we don’t want to create and delete a temporary file representing our test Cat Person, so we’ll mock <code class="highlighter-rouge">json</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># test_example_1.py</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">main</span> <span class="kn">import</span> <span class="n">is_cat_person</span>

<span class="k">class</span> <span class="nc">TestIsCatPerson</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@patch</span><span class="p">(</span><span class="s">'json'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_returns_true_for_cat_person</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_json</span><span class="p">):</span>
        <span class="n">mock_json</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'meyers_briggs_type'</span><span class="p">:</span> <span class="s">'INTJ'</span><span class="p">,</span>
            <span class="s">'likes_laser_pointers'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'dresses_like_a_cat'</span><span class="p">:</span> <span class="bp">True</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">is_cat_person</span><span class="p">(</span><span class="s">'path/to/person'</span><span class="p">))</span>

</code></pre></div></div>

<p>Why doesn’t this work?</p>

<details><summary>Show error message</summary>
<p>

<code>
Error
Traceback (most recent call last):
  ...
  File "./venv/lib/python2.7/site-packages/mock/mock.py", line 1522, in _get_target
    (target,))
TypeError: Need a valid target to patch. You supplied: 'json'
</code>

</p>
</details>

<details><summary>Show the mistake</summary>
<p>

As the traceback indicates, <code>mock.patch</code> can't find the <code>json</code> module. This can be fixed by changing the patch line to <code>@patch('main.json')</code> This fits with the rule of thumb from the <a href="http://www.voidspace.org.uk/python/mock/patch.html#where-to-patch">documentation</a>  that you should "patch where an object is looked up, which is not necessarily the same place as where it is defined." However, in this case, that isn't the full story: the specific error produced within the mock library is caused by any patch that doesn't involve a <code>.</code> as a separator (the same is true in Python 3's unittest.mock library). If we were to instead use <code>@patch('json.load')</code>, modifying the return value statement to remove the redundant <code>.load</code>, we'd be breaking the rule and mocking it where it came from, but it still works: we're mocking the function from the <code>json</code> package, but <code>main.py</code>'s import points to the whole package. However, if <code>main.py</code> is rewritten to use <code>from json import load</code>, and we tried to patch <code>json.load</code> instead of <code>main.load</code>, our test would fail, since we wouldn't be patching the function we're using.
</p>
</details>

<hr />

<h3 id="example-mistake-2">Example mistake 2</h3>

<p>Now we’ve modified our <code class="highlighter-rouge">is_cat_person</code> function slightly to include a call to a <code class="highlighter-rouge">validate</code> function, which checks that the json we’ve loaded has a valid <code class="highlighter-rouge">validation_id</code> property, throwing an exception if it doesn’t:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># main.py</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">is_cat_person</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">person_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">validate</span><span class="p">(</span><span class="n">person_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'validation_id'</span><span class="p">)):</span>
        <span class="o">...</span>
        <span class="c"># Do some stuff with person_json and return True if Cat Person, False otherwise</span>
</code></pre></div></div>

<p>Let’s say the validation function is time-consuming, so we modify the previous test to mock validation:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># test_example_2.py</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">main</span> <span class="kn">import</span> <span class="n">is_cat_person</span>

<span class="k">class</span> <span class="nc">TestIsCatPerson</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@patch</span><span class="p">(</span><span class="s">'main.json'</span><span class="p">)</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s">'main.validate'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_returns_true_for_cat_person</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_json</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="n">mock_json</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'meyers_briggs_type'</span><span class="p">:</span> <span class="s">'INTJ'</span><span class="p">,</span>
            <span class="s">'likes_laser_pointers'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'dresses_like_a_cat'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'validation_id'</span><span class="p">:</span> <span class="s">'h19d8w22'</span> 
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">is_cat_person</span><span class="p">(</span><span class="s">'path/to/person'</span><span class="p">))</span>
</code></pre></div></div>

<p>What’s wrong with this?</p>

<details><summary>Show error message.</summary>
<p>

In this case, the test fails, but there is not necessarily any error beyond <code>AssertionError: False is not true</code>.
</p>
</details>

<details><summary>Show the mistake.</summary>
<p>

The problem is the decorator order: as things stand, <code>mock_json</code> is mocking <code>main.validate</code>, and <code>mock_validate</code> is mocking <code>main.json</code>. Decorators move outward/upward from the decorated function, so the arguments need to have that order. When I set this up, there was no error, because the person object returned by <code>mock_validate</code> was taken as truthy, and the <code>True</code> that was returned by <code>mock_json</code> was found to not be a cat person.

Side note: I'm currently reading and enjoying <a href="https://www.amazon.com/Clean-Code-Handbook-Software-Craftsmanship/dp/0132350882">Clean Code</a> as part of our engineering book club, and I've been thinking about the way that some of these error-prone mocking situations come about in part because the functions we're testing are too long and/or work at multiple levels of abstraction. Why should one function be responsible for loading json from a file, validating that json, and also performing a classification? But we'll stick with it for now, since it's convenient for these examples.
</p>
</details>

<hr />

<h3 id="example-mistake-3">Example mistake 3</h3>

<p>Suppose we now want to do a more comprehensive test, in which we check the logic of how the function deals with valid and invalid input, using our own simplified version of validation.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># test_example_3.py</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">main</span> <span class="kn">import</span> <span class="n">is_cat_person</span>

<span class="k">def</span> <span class="nf">simplified_validate</span><span class="p">(</span><span class="n">validation_string</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">validation_string</span> <span class="o">==</span> <span class="s">'h19d8w22'</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="nb">Exception</span><span class="p">(</span><span class="s">'Invalid validation id'</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">TestIsCatPerson</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@patch</span><span class="p">(</span><span class="s">'main.validate'</span><span class="p">)</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s">'main.json'</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_validation_logic_flow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_json</span><span class="p">,</span> <span class="n">mock_validate</span><span class="p">):</span>
        <span class="n">mock_validate</span> <span class="o">=</span> <span class="n">simplified_validate</span>

        <span class="n">mock_json</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'meyers_briggs_type'</span><span class="p">:</span> <span class="s">'INTJ'</span><span class="p">,</span>
            <span class="s">'likes_laser_pointers'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'dresses_like_a_cat'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'validation_id'</span><span class="p">:</span> <span class="s">'h19d8w22'</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">is_cat_person</span><span class="p">(</span><span class="s">'path/to/person'</span><span class="p">))</span>

        <span class="n">mock_json</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'meyers_briggs_type'</span><span class="p">:</span> <span class="s">'INTJ'</span><span class="p">,</span>
            <span class="s">'likes_laser_pointers'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'dresses_like_a_cat'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'validation_id'</span><span class="p">:</span> <span class="s">'zzzzzzzz'</span>   <span class="c"># Should trigger a validation exception</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="nb">Exception</span><span class="p">,</span> <span class="n">is_cat_person</span><span class="p">,</span> <span class="s">'path/to/person'</span><span class="p">)</span>
</code></pre></div></div>

<details><summary>Show error message</summary>
<p>

The first assertion passes, but the second doesn't. There's no meaningful error, other than the fact that an exception isn't raised. A good IDE might call your attention to the <code>mock_validate</code> argument in the two places where it's used.
</p>
</details>

<details><summary>Show mistake</summary>
<p>

It <i>looks</i> like this is setting up <code>simplified_validate</code> to be a stand-in for <code>mock_validate</code>, and by extension a stand-in for <code>main.validate</code>, but the substitution isn't taking place. Instead, we want to use <code>mock_validate.side_effect = simplified_validate</code>, or to simplify things visually, we could change the patch line to <code>@patch('main.validate', side_effect=simplified_validate)</code> and omit the <code>mock_validate</code> argument. I find the <code>side_effect</code> terminology a bit confusing, since the term doesn't do anything to capture the fact that this <code>side_effect</code> will in effect be subbed in for the mocked function and called with the same arguments. If anyone has a good way of explaining this, I'm all ears.
</p>
</details>

<hr />

<h3 id="example-mistake-4">Example mistake 4</h3>

<p>Let’s revisit example 2, but with two differences. First, we’ve switched to using a <code class="highlighter-rouge">Validator</code> object, vs a simple <code class="highlighter-rouge">validate</code> function:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># main.py</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="k">def</span> <span class="nf">is_cat_person</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">person_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Validator</span><span class="p">()</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">person_json</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">'validation_id'</span><span class="p">)):</span>
        <span class="o">...</span>
        <span class="c"># Do some stuff with person_json and return True if Cat Person, False otherwise</span>
</code></pre></div></div>

<p>Second, this time we’ll dodge the patch-ordering issue completely by specifying that our mock Validator will be a general <code class="highlighter-rouge">MagicMock</code> instance:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># test_example_4.py</span>
<span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">mock</span> <span class="kn">import</span> <span class="n">MagicMock</span><span class="p">,</span> <span class="n">patch</span>
<span class="kn">from</span> <span class="nn">main</span> <span class="kn">import</span> <span class="n">is_cat_person</span>

<span class="k">class</span> <span class="nc">TestIsCatPerson</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="nd">@patch</span><span class="p">(</span><span class="s">'main.json'</span><span class="p">)</span>
    <span class="nd">@patch</span><span class="p">(</span><span class="s">'main.Validator'</span><span class="p">,</span> <span class="n">MagicMock</span><span class="p">())</span>
    <span class="k">def</span> <span class="nf">test_returns_true_for_cat_person</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mock_json</span><span class="p">):</span>
        <span class="n">mock_json</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">return_value</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s">'meyers_briggs_type'</span><span class="p">:</span> <span class="s">'INTJ'</span><span class="p">,</span>
            <span class="s">'likes_laser_pointers'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'dresses_like_a_cat'</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
            <span class="s">'validation_id'</span><span class="p">:</span> <span class="s">'h19d8w22'</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="n">is_cat_person</span><span class="p">(</span><span class="s">'path/to/person'</span><span class="p">))</span>
</code></pre></div></div>

<details><summary>Show error message</summary>
<p>

No error message, and the test passes.
</p>
</details>

<details><summary>Show mistake</summary>
<p>

This is a subtle/debatable one. Whether or not this is ok hinges on how much we depend on this test to tell us if something changes about how the <code>Validator</code> object is defined and used in <code>main.py</code>. By making it a <code>MagicMock</code> instance, it will continue working even if the <code>Validator</code> method called within <code>is_cat_person</code> changes or stops existing. This is one drawback of the flexibility of <code>MagicMock</code>. The alternative is to import the Validator object and use the mock library's <code>create_autospec</code> function, as in: <code>@patch('main.Validator', create_autospec(Validator))</code>.
</p>
</details>

<hr />

<p>Those are all the big ones I’ve run up against so far. Happy mocking!</p>

<p>(<a href="https://www.pexels.com/photo/animal-pet-cute-kitten-45201/">Kitten image source</a>, CC0 license)</p>


  <div class="text-center mb-1">
  <div class="addthis_inline_share_toolbox"></div>
</div>

  

<hr>

<div class="authors">
  <h4 class="mb-3">
  
  Author
  
</h4>

  <div class="row">
    
    <div class="col-12">
      <div class="author mb-3">
        <a href="https://github.com/raphey">
          <img class="rounded mr-2" src="https://avatars.githubusercontent.com/raphey" alt="Raphey Holmes" width="64">
          <span class="author-details">
            <h6>Raphey Holmes</h6>
            
          </span>
        </a>
      </div>
    </div>
    
  </div>
</div>

</div>

<footer class="page-footer text-light bg-theme-grey-dark">
    <div class="container py-3">
      <div class="row">
        <div class="col-12 col-md-6">
          <h5 class="text-white text-font-headline">
            GoDaddy Engineering
          </h5>
          <p>
            At GoDaddy we build next-generation experiences that empower the world's small business owners to start and grow their independent ventures.

            <a href="https://careers.godaddy.com/?source=APPLICANT_SOURCE-3-118&utm_source=godaddy-oss" title="Work at GoDaddy">
              Join us!
            </a>
          </p>
        </div>
        <div class="col-12 col-md-4 offset-md-2">
          <h5 class="text-white text-font-headline">
            On the web
          </h5>
          <ul class="list-unstyled mb-0">
  
  
  <li>
    <a class="text-light" href="https://github.com/godaddy" title="godaddy on GitHub">
      GitHub
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://twitter.com/GodaddyOSS" title="GodaddyOSS on Twitter">
      Twitter
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://dribbble.com/GoDaddy" title="GoDaddy on Dribbble">
      Dribbble
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://www.facebook.com/GoDaddy" title="GoDaddy on Facebook">
      Facebook
    </a>
  </li>
  
  
</ul>

        </div>
      </div>
    </div>
    <div class="footer-copyright bg-extra-dark text-center text-light font-weight-light py-3">
      <small>
        Copyright © 1999 - 2018 GoDaddy Operating Company, LLC. All Rights Reserved.

      </small>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>


<script async src="https://www.google-analytics.com/analytics.js"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js"></script>
<script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-37178807-20', 'auto');
  ga('require', 'outboundLinkTracker');
  ga('send', 'pageview');
</script>



<script async src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b039a09ed801a5d"></script>






</body>
</html>

