<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Mocking SOAP APIs in functional tests using Nock — GoDaddy Engineering Blog</title>
  <meta name="description" content="Information from our engineering team about the technology and tools we use to create software which empowers small businesses around the world to build and market their digital identities.
">

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link rel="stylesheet" href="/engineering/assets/css/main.css">

  <meta name="theme-color" content="#4095e8">
  <meta name="msapplication-TileColor" content="#4095e8">
  <link rel="apple-touch-icon" sizes="180x180" href="/engineering/assets/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/engineering/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/engineering/assets/images/favicon-16x16.png">
  <link rel="manifest" href="/engineering/site.webmanifest">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/engineering/feed.xml" title="GoDaddy Engineering Blog" />

  
  <link rel="canonical" href="http://localhost:4000/2018/10/02/mocking-soap-apis-in-functional-tests-using-nock/">
  

  <meta property="og:locale" content="en_US">
  <meta property="og:site_name" content="GoDaddy Engineering Blog">
  <meta property="og:url" content="http://localhost:4000/2018/10/02/mocking-soap-apis-in-functional-tests-using-nock/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@GodaddyOSS">

  
  <meta property="og:image" content="http://localhost:4000/assets/images/headers/using-nock.jpg">
  

  
  <meta property="og:title" content="Mocking SOAP APIs in functional tests using Nock — GoDaddy Engineering Blog">
  

  
  <meta property="og:description" content="This post explains why and how to mock the external REST and SOAP APIs in the functional tests of a service written in NodeJS to have a more robust CICD. In this post, We will write a simple functional tests and mock the external API using `nock` node module.">
  

  <link rel="preload" href="//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: Boing-Bold;
    src: url(//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff) format("woff");
    font-display: swap;
  }
  </style>
  <link rel="preload" href="//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: gdsherpa;
    src: url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff) format("woff");
    font-weight: 700;
    font-display: swap;
  }
  </style>
  <link rel="preload" href="//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: gdsherpa;
    src: url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff) format("woff");
    font-display: swap;
  }
  </style>
</head>

  <body class="layout--post page--mocking-soap-apis-in-functional-tests-using-nock">
    <nav class="navbar utility-bar navbar-dark bg-theme-grey-dark px-3 py-0">
  <a class="navbar-brand pt-1 pb-0" href="https://www.godaddy.com">
    <svg class="logo-mark logo-mark-white" height="18" viewBox="0 0 367.7 78.1" xmlns="http://www.w3.org/2000/svg"><path class="logo-mark-color" d="M95.3 38.6c0-4.6-3.6-8.4-8.3-8.4-4.6 0-8.3 3.8-8.3 8.4s3.6 8.3 8.3 8.3 8.3-3.7 8.3-8.3m14.4.1c0 11.9-10.1 21.4-22.6 21.4-12.6 0-22.6-9.5-22.6-21.4 0-12 10.1-21.6 22.6-21.6 12.5-.1 22.6 9.6 22.6 21.6M154.8 30c0-8-5.6-15-13.9-15h-11.5v30.3h11.5c8.3 0 13.9-7.3 13.9-15.3m15.5 0c0 17.1-12.1 28.8-29.1 28.8h-24.6c-1.2 0-2.1-.9-2.1-2V3.4c0-1.1.9-2 2.1-2h24.6c17.1.1 29.1 11.5 29.1 28.6M194.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4 0 4.7 3.7 8.4 8.3 8.4M192.2 17c4.9 0 8.8 1.8 10.5 4.3v-1.2c0-1.1.9-1.9 1.9-1.9H215c1.1 0 1.9.8 1.9 1.9v36.8c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-1.7 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6s10-21.4 20.4-21.4M241.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4 0 4.7 3.7 8.4 8.3 8.4M238.9 17c5 0 8.9 1.9 10.7 4.1V3.4c0-1.1.9-1.9 1.9-1.9H262c1.1 0 1.9.8 1.9 1.9V57c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-2.1 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6S228.7 17 238.9 17M288.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4.1 4.7 3.7 8.4 8.3 8.4M286 17c5 0 8.9 1.9 10.7 4.1V3.4c0-1.1.9-1.9 1.9-1.9H309c1.1 0 1.9.8 1.9 1.9V57c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-2.1 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6S275.7 17 286 17M345.5 64.7c-2.6 8.6-8.6 13.4-18 13.4-5.1 0-10.1-1.7-13.3-4.5-.5-.5-.8-1.1-.8-1.7 0-.5.2-1.1.7-1.7l3.9-5.9c.6-.8 1.5-.9 1.7-.9.9 0 1.3.2 2.1.8 1.2.8 2.9 1.8 4.8 1.8 1.6 0 3.7-.7 4.5-3.1l1.3-4.1H326c-1.3 0-2.1-.9-2.5-2L313 21.5c-.2-.9-.3-1.4-.3-1.7 0-.8.6-1.5 1.7-1.5h12.4c1.1 0 1.7 1 2 2l6.9 25.4h.5l5.5-25.4c.2-1 .9-2 2-2h12.6c1.2 0 1.7.7 1.7 1.5 0 .3-.1.8-.3 1.7l-12.2 43.2M49.7 50.9c-5 6.9-13.2 9.2-20.5 9.2C12.4 60.1 0 47.6 0 30.2.1 13.5 13.5.2 31 .2c13 0 23.4 5.5 28.1 16 .6 1.2 1 3.2-2.5 3.8l-9.2 1.6c-2.1.4-3.3-1-3.7-1.6-2.7-3.7-7.1-6.2-12.4-6.2-9.2 0-15.7 7-15.7 16.3 0 10.3 7.4 16.3 15.5 16.3 5.4 0 9.8-2 12.7-5.8h-8.1c-1.2 0-2.1-.9-2.1-2v-7.7c0-1.1.9-2 2.1-2h24.7c1.2 0 2.1.9 2.1 2v25.9c0 1.1-.9 2-2.1 2h-8.6c-1.2 0-2.1-.9-2.1-2v-5.9M359.8 0c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14.4c-3.5 0-6.4-2.9-6.4-6.4s2.9-6.4 6.4-6.4 6.4 2.9 6.4 6.4-2.9 6.4-6.4 6.4z"></path><path class="logo-mark-color" d="M361.4 6.5c0-.4-.1-.7-.4-.8-.2-.2-.6-.4-.9-.4h-1.4v2.3h1.4c.4 0 .7-.1.9-.4.2-.2.4-.4.4-.7zm-3.1 5.9h-1.5c-.1 0-.1 0-.2-.1 0-.1-.1-.1-.1-.2V3.8c0-.1 0-.1.1-.2.1 0 .1-.1.2-.1h3.3c1.1 0 1.9.2 2.5.8s.9 1.3.9 2.1c0 .6-.1 1.1-.5 1.5-.4.5-.7.8-1.2 1.1l1.9 2.9c.1.1.1.2 0 .4 0 .1-.1.1-.2.1H362c-.1 0-.2 0-.4-.1-.1 0-.1-.1-.2-.2l-1.6-2.7h-1.2V12c0 .1 0 .1-.1.2s-.1.2-.2.2z"></path></svg>
    &nbsp;
  </a>
</nav>

<nav class="navbar navbar-top navbar-expand-md navbar-light bg-white">
  <a class="navbar-brand font-weight-bold" href="http://localhost:4000/engineering/" title="GoDaddy Engineering">
    GoDaddy Engineering
  </a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#topnav" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="topnav">
    <ul class="navbar-nav ml-auto">
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/featured-projects/" title="Featured Projects">
          Featured Projects
        </a>
      </li>
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/blog-posts/" title="Blog Posts">
          Blog Posts
        </a>
      </li>
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/code-of-conduct/" title="Code of Conduct">
          Code of Conduct
        </a>
      </li>
      
      
      <li class="nav-item">
        <a class="nav-link btn btn-primary text-white font-weight-bold px-3" href="https://careers.godaddy.com/?source=APPLICANT_SOURCE-3-118&utm_source=godaddy-oss" title="Work at GoDaddy">
          Join us!
        </a>
      </li
    </ul>
  </div>
</nav>





<div class="container text-line-height-2x pt-3">
  <h1 class="mb-3 text-line-height-1-5-em">
    Mocking SOAP APIs in functional tests using Nock
  </h1>

  <p>I work on writing services using Node.js on a customer experience team at
GoDaddy. These services use data from different products across GoDaddy to
provide personalized customer data to the client teams. To collect these data,
we call different GoDaddy wide services. And this is where the real complication
comes in. Since we don’t have control of these services, some of them are still
legacy. And by legacy here I mean SOAP services as well. Yes, you read it right.
<a href="https://en.wikipedia.org/wiki/SOAP">SOAP services</a>.</p>

<p>We initially started writing our functional tests calling real/live APIs. But
then the functional tests became unreliable.</p>

<p>Here are the reasons why:</p>
<ol>
  <li>The dependent services were slow.</li>
  <li>The dependent services were flaky.</li>
  <li>Covering corner cases with real test data is challenging. An example: Your
service has a special handling for data returned by external service which
contains products having last day of their free trial.</li>
</ol>

<p>Using live APIs became more of a pain for our CICD process. It also made our
CICD process slow and flaky.</p>

<p>This is when we spent time looking at different options to fix the test
flakiness. One of the approach was to avoid calling the dependent services in
our functional tests. During investigation of this approach, we came across
<a href="https://github.com/nock/nock">Nock</a>.</p>

<h2 id="what-is-nock">What is Nock?</h2>

<p>Nock is an HTTP server mocking library for Node.js applications.</p>

<p>Nock intercepts HTTP request made using Node’s <code class="highlighter-rouge">http.request</code> or
<code class="highlighter-rouge">http.ClientRequest</code> modules and responds with the expected/mocked status code
and response.</p>

<h2 id="nock-setup">Nock setup</h2>

<p>Install Nock by running:</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm i <span class="nt">--save-dev</span> nock
</code></pre></div></div>

<h2 id="mocking-rest-service">Mocking REST service</h2>

<p>Assume the service under development has an endpoint <code class="highlighter-rouge">/user</code> which returns
<code class="highlighter-rouge">fullname</code> derived from the response of the dependent service, the test snippet
would be:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">nock</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'nock'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'request'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">DEPENDENT_SERVICE_HOST</span> <span class="o">=</span> <span class="s1">'https://calling.dependent-service.com'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">DEPENDENT_SERVICE_PATH</span> <span class="o">=</span> <span class="s1">'/user'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">NEW_SERVICE_HOST</span> <span class="o">=</span> <span class="s1">'https://testing.new-service.com'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">setupNock</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">nock</span><span class="p">(</span><span class="nx">DEPENDENT_SERVICE_HOST</span><span class="p">)</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">DEPENDENT_SERVICE_PATH</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="p">{</span> <span class="na">firstname</span><span class="p">:</span> <span class="s1">'foo'</span><span class="p">,</span> <span class="na">lastname</span><span class="p">:</span> <span class="s1">'bar'</span> <span class="p">});</span>
<span class="p">};</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'New Service'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'/user endpoint returns fullname'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setupNock</span><span class="p">();</span>
    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">NEW_SERVICE_HOST</span><span class="p">)</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/user'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">body</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">fullname</span><span class="p">:</span> <span class="s1">'foo bar'</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>
<p>You can also test how your service handles errors such as a <code class="highlighter-rouge">500</code> status from
the dependent service. To do so update the <code class="highlighter-rouge">setupNock</code> to</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">nock</span><span class="p">(</span><span class="nx">DEPENDENT_SERVICE_HOST</span><span class="p">)</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">DEPENDENT_SERVICE_HOST</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">reply</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</code></pre></div></div>

<p>You can also store the mock respone from the dependent service in separate
files. Use <code class="highlighter-rouge">replyWithFile</code> in such cases</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nx">nock</span><span class="p">(</span><span class="nx">DEPENDENT_SERVICE_HOST</span><span class="p">)</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">OLD_SERVICE_HOST</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replyWithFile</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'./mocks/user.json'</span><span class="p">));</span>
</code></pre></div></div>

<p>All the above snippets looks pretty straightforward, but they are mocking REST
APIs.</p>

<p>How would you achieve the same when the dependent service is a SOAP service?</p>

<h2 id="mocking-soap-services">Mocking SOAP services</h2>

<p>Mocking SOAP services are a bit tricky since it involves first mocking the WSDL
document which describes the SOAP service and then the SOAP action. Below are
the steps to achieve that.</p>

<p>To get started, use <code class="highlighter-rouge">GetCountriesAvailable</code> action of the SOAP service
http://holidaywebservice.com/HolidayService_v2/HolidayService2.asmx?WSDL and try
mocking it with Nock.</p>

<h3 id="step-1-create-a-service">Step 1: Create a service</h3>

<p>We will build a new service that returns <code class="highlighter-rouge">CountryCode: { Code, Description }</code>
from the SOAP service’s response. The code snippet for the <code class="highlighter-rouge">GET</code> call would be:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">express</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'express'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">app</span> <span class="o">=</span> <span class="nx">express</span><span class="p">();</span>

<span class="nx">app</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/countries'</span><span class="p">,</span> <span class="k">async</span> <span class="p">(</span><span class="nx">req</span><span class="p">,</span> <span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="kd">const</span> <span class="nx">SOAP_API_URL</span> <span class="o">=</span> <span class="s1">'http://holidaywebservice.com/HolidayService_v2/HolidayService2.asmx?WSDL'</span><span class="p">;</span>
  <span class="kd">const</span> <span class="nx">client</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">soap</span><span class="p">.</span><span class="nx">createClientAsync</span><span class="p">(</span><span class="nx">SOAP_API_URL</span><span class="p">);</span>
  <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">client</span><span class="p">.</span><span class="nx">GetCountriesAvailableAsync</span><span class="p">();</span>
  <span class="nx">res</span><span class="p">.</span><span class="nx">status</span><span class="p">(</span><span class="mi">200</span><span class="p">).</span><span class="nx">json</span><span class="p">(</span><span class="nx">result</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">GetCountriesAvailableResult</span><span class="p">.</span><span class="nx">CountryCode</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="step-2-setup-npm-test">Step 2: Setup <code class="highlighter-rouge">npm test</code></h3>

<p>Add a test runner like <code class="highlighter-rouge">mocha</code> in your repository. Add the below line in
<code class="highlighter-rouge">scripts</code> key of <code class="highlighter-rouge">package.json</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="w">  </span><span class="s2">"test"</span><span class="p">:</span><span class="w"> </span><span class="s2">"mocha test-functional/**/*.test.js --timeout 30000"</span><span class="w">
</span></code></pre></div></div>

<h3 id="step-3-example-test-code">Step 3: Example Test Code</h3>

<p>We will use <a href="https://www.npmjs.com/package/supertest">supertest</a> npm module for
the API testing.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">request</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'supertest'</span><span class="p">);</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'/countries'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./server'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/countries'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">Code</span><span class="p">:</span> <span class="s1">'Canada'</span><span class="p">,</span> <span class="na">Description</span><span class="p">:</span> <span class="s1">'Canada'</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<p>This will call the external SOAP service when ran in CICD, which leads to slow
and flaky tests.</p>

<p>Instead of relying on the actual service, lets see how to mock the SOAP service.</p>

<h3 id="step-4-mocking-wsdl-document">Step 4: Mocking WSDL document</h3>

<p>This is the first of two steps in mocking the SOAP service.</p>

<p>First, we will have to mock the WSDL response of the SOAP API. The WSDL is an
XML document which describes the service and the actions the service can
perform.</p>

<p>You can find WSDL document for the service
<a href="http://holidaywebservice.com/HolidayService_v2/HolidayService2.asmx?WSDL">here</a>.
For mocking, we copy the contents into <code class="highlighter-rouge">./mocks/holiday-service-wsdl.xml</code>.</p>

<p>Also, create a function <code class="highlighter-rouge">setupWsdlNock</code> to mock the wsdl response.</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'path'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">nock</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'nock'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">SOAP_API_HOST</span> <span class="o">=</span> <span class="s1">'http://holidaywebservice.com'</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">SOAP_API_PATH</span> <span class="o">=</span> <span class="s1">'/HolidayService_v2/HolidayService2.asmx?WSDL'</span><span class="p">;</span>

<span class="kd">const</span> <span class="nx">setupWsdlNock</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">nock</span><span class="p">(</span><span class="nx">SOAP_API_HOST</span><span class="p">)</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">SOAP_API_PATH</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replyWithFile</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'./mocks/holiday-service-wsdl.xml'</span><span class="p">));</span>
<span class="p">};</span>
</code></pre></div></div>

<h3 id="step-5-mocking-soap-action">Step 5: Mocking SOAP action</h3>

<p>The next step would be to mock the actual SOAP action which returns the test
data that we expect.</p>

<p>Again, create another file <code class="highlighter-rouge">./mocks/get-countries-mock.xml</code> with the below
contents:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;soap:Envelope</span> <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="na">xmlns:xsd=</span><span class="s">"http://www.w3.org/2001/XMLSchema"</span> <span class="na">xmlns:soap=</span><span class="s">"http://schemas.xmlsoap.org/soap/envelope/"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;soap:Body&gt;</span>
    <span class="nt">&lt;GetCountriesAvailableResponse</span> <span class="na">xmlns=</span><span class="s">"http://www.holidaywebservice.com/HolidayService_v2/"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;GetCountriesAvailableResult&gt;</span>
        <span class="nt">&lt;CountryCode&gt;</span>
          <span class="nt">&lt;Code&gt;</span>Iceland<span class="nt">&lt;/Code&gt;</span>
          <span class="nt">&lt;Description&gt;</span>Most sparsely populated city in Europe<span class="nt">&lt;/Description&gt;</span>
        <span class="nt">&lt;/CountryCode&gt;</span>
        <span class="nt">&lt;CountryCode</span> <span class="nt">/&gt;</span>
      <span class="nt">&lt;/GetCountriesAvailableResult&gt;</span>
    <span class="nt">&lt;/GetCountriesAvailableResponse&gt;</span>
  <span class="nt">&lt;/soap:Body&gt;</span>
<span class="nt">&lt;/soap:Envelope&gt;</span>
</code></pre></div></div>

<p>Also add the following code in the test</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">setupGetCountriesNock</span> <span class="o">=</span> <span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="nx">filename</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">nock</span><span class="p">(</span><span class="nx">SOAP_API_HOST</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">reqHeaders</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">soapaction</span><span class="p">:</span> <span class="s2">`"</span><span class="p">${</span><span class="nx">SOAP_API_HOST</span><span class="p">}</span><span class="s2">/HolidayService_v2/GetCountriesAvailable"`</span>
    <span class="p">}</span>
  <span class="p">})</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/HolidayService_v2/HolidayService2.asmx'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replyWithFile</span><span class="p">(</span><span class="nx">status</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="nx">filename</span><span class="p">));</span>
<span class="p">}</span>

<span class="nx">describe</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">it</span><span class="p">(</span><span class="s1">'/countries'</span><span class="p">,</span> <span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">setupWsdlNock</span><span class="p">();</span>
    <span class="nx">setupGetCountriesNock</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="s1">'./mocks/get-countries-mock.xml'</span><span class="p">);</span>

    <span class="kd">const</span> <span class="nx">server</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./server'</span><span class="p">);</span>
    <span class="kd">const</span> <span class="nx">result</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">request</span><span class="p">(</span><span class="nx">server</span><span class="p">)</span>
      <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s1">'/countries'</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">expect</span><span class="p">(</span><span class="mi">200</span><span class="p">);</span>
    <span class="nx">expect</span><span class="p">(</span><span class="nx">result</span><span class="p">).</span><span class="nx">toEqual</span><span class="p">({</span> <span class="na">Code</span><span class="p">:</span> <span class="s1">'Iceland'</span><span class="p">,</span> <span class="na">Description</span><span class="p">:</span> <span class="s1">'Most sparsely populated city in Europe'</span> <span class="p">});</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre></div></div>

<h3 id="step-6-running-the-test">Step 6: Running the test</h3>

<p>Now run <code class="highlighter-rouge">npm test</code> and magic - You have your dependent SOAP service mocked.</p>

<h2 id="troubleshooting">Troubleshooting</h2>

<ol>
  <li>If you get an error like <code class="highlighter-rouge">Error: Nock: No match for request</code>, make sure to
compare the <code class="highlighter-rouge">hostname</code>, <code class="highlighter-rouge">path</code> and the <code class="highlighter-rouge">reqHeaders.soapaction</code> in the test
case with the actual request made.</li>
  <li>Nock interceptor resets itself after the first call to the SOAP service.
Hence, if you have more than one call to the same SOAP service, make sure to
mock the service using <code class="highlighter-rouge">times</code> function of Nock.</li>
</ol>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">return</span> <span class="nx">nock</span><span class="p">(</span><span class="s1">'http://holidaywebservice.com'</span><span class="p">,</span> <span class="p">{</span>
    <span class="na">reqHeaders</span><span class="p">:</span> <span class="p">{</span>
      <span class="na">soapaction</span><span class="p">:</span> <span class="s2">`"http://www.holidaywebservice.com/HolidayService_v2/GetCountriesAvailable"`</span>
    <span class="p">}</span>
  <span class="p">})</span>
    <span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s1">'/HolidayService_v2/HolidayService2.asmx'</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">times</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">.</span><span class="nx">replyWithFile</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span> <span class="s1">'./mocks/GetCountriesAvailable.xml'</span><span class="p">));</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>Using Nock will make your functional test less flaky and more independent of
external factors. This will make your CICD more robust, fast and trustable.
Hence, increasing your productivity and decreasing the time waiting for the
build to be green with your fingers crossed.</p>

<h2 id="references">References:</h2>
<ul>
  <li><a href="https://github.com/nock/nock">Nock</a></li>
  <li><a href="https://en.wikipedia.org/wiki/SOAP">SOAP</a></li>
</ul>


  <div class="text-center mb-1">
  <div class="addthis_inline_share_toolbox"></div>
</div>

  

<hr>

<div class="authors">
  <h4 class="mb-3">
  
  Author
  
</h4>

  <div class="row">
    
    <div class="col-12">
      <div class="author mb-3">
        <a href="https://www.linkedin.com/in/adeepti10/">
          <img class="rounded mr-2" src="/engineering/assets/images/dagrawal.jpg" alt="Deepti Agrawal" width="64">
          <span class="author-details">
            <h6>Deepti Agrawal</h6>
            
          </span>
        </a>
      </div>
    </div>
    
  </div>
</div>

</div>

<footer class="page-footer text-light bg-theme-grey-dark">
    <div class="container py-3">
      <div class="row">
        <div class="col-12 col-md-6">
          <h5 class="text-white text-font-headline">
            GoDaddy Engineering
          </h5>
          <p>
            At GoDaddy we build next-generation experiences that empower the world's small business owners to start and grow their independent ventures.

            <a href="https://careers.godaddy.com/?source=APPLICANT_SOURCE-3-118&utm_source=godaddy-oss" title="Work at GoDaddy">
              Join us!
            </a>
          </p>
        </div>
        <div class="col-12 col-md-4 offset-md-2">
          <h5 class="text-white text-font-headline">
            On the web
          </h5>
          <ul class="list-unstyled mb-0">
  
  
  <li>
    <a class="text-light" href="https://github.com/godaddy" title="godaddy on GitHub">
      GitHub
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://twitter.com/GodaddyOSS" title="GodaddyOSS on Twitter">
      Twitter
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://dribbble.com/GoDaddy" title="GoDaddy on Dribbble">
      Dribbble
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://www.facebook.com/GoDaddy" title="GoDaddy on Facebook">
      Facebook
    </a>
  </li>
  
  
</ul>

        </div>
      </div>
    </div>
    <div class="footer-copyright bg-extra-dark text-center text-light font-weight-light py-3">
      <small>
        Copyright © 1999 - 2018 GoDaddy Operating Company, LLC. All Rights Reserved.

      </small>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>


<script async src="https://www.google-analytics.com/analytics.js"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js"></script>
<script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-37178807-20', 'auto');
  ga('require', 'outboundLinkTracker');
  ga('send', 'pageview');
</script>



<script async src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b039a09ed801a5d"></script>






</body>
</html>

