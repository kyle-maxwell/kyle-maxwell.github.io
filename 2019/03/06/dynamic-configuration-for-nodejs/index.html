<!doctype html>
<html lang="en-US">
  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>Dynamic Configuration for Node.js Applications — GoDaddy Engineering Blog</title>
  <meta name="description" content="Information from our engineering team about the technology and tools we use to create software which empowers small businesses around the world to build and market their digital identities.
">

  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
  <link rel="stylesheet" href="/engineering/assets/css/main.css">

  <meta name="theme-color" content="#4095e8">
  <meta name="msapplication-TileColor" content="#4095e8">
  <link rel="apple-touch-icon" sizes="180x180" href="/engineering/assets/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/engineering/assets/images/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/engineering/assets/images/favicon-16x16.png">
  <link rel="manifest" href="/engineering/site.webmanifest">
  <link type="application/atom+xml" rel="alternate" href="http://localhost:4000/engineering/feed.xml" title="GoDaddy Engineering Blog" />

  
  <link rel="canonical" href="http://localhost:4000/2019/03/06/dynamic-configuration-for-nodejs/">
  

  <meta property="og:locale" content="en_US">
  <meta property="og:site_name" content="GoDaddy Engineering Blog">
  <meta property="og:url" content="http://localhost:4000/2019/03/06/dynamic-configuration-for-nodejs/">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@GodaddyOSS">

  
  <meta property="og:image" content="http://localhost:4000/assets/images/headers/flipr.jpg">
  

  
  <meta property="og:title" content="Dynamic Configuration for Node.js Applications — GoDaddy Engineering Blog">
  

  
  <meta property="og:description" content="Dynamic configuration is a powerful tool for software applications. Use it to solve problems like authorization, feature flags, and A/B tests, in addition to normal application configuration. See how GoDaddy uses a library called flipr to achieve this for some of its Node.js applications.">
  

  <link rel="preload" href="//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: Boing-Bold;
    src: url(//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/boing/1.0/Boing-Bold.woff) format("woff");
    font-display: swap;
  }
  </style>
  <link rel="preload" href="//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: gdsherpa;
    src: url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-bold.woff) format("woff");
    font-weight: 700;
    font-display: swap;
  }
  </style>
  <link rel="preload" href="//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff2" as="font" type="font/woff2" crossOrigin />
  <style>
  @font-face {
    font-family: gdsherpa;
    src: url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff2) format("woff2"), url(//img1.wsimg.com/ux/fonts/sherpa/1.0/gdsherpa-regular.woff) format("woff");
    font-display: swap;
  }
  </style>
</head>

  <body class="layout--post page--dynamic-configuration-for-nodejs">
    <nav class="navbar utility-bar navbar-dark bg-theme-grey-dark px-3 py-0">
  <a class="navbar-brand pt-1 pb-0" href="https://www.godaddy.com">
    <svg class="logo-mark logo-mark-white" height="18" viewBox="0 0 367.7 78.1" xmlns="http://www.w3.org/2000/svg"><path class="logo-mark-color" d="M95.3 38.6c0-4.6-3.6-8.4-8.3-8.4-4.6 0-8.3 3.8-8.3 8.4s3.6 8.3 8.3 8.3 8.3-3.7 8.3-8.3m14.4.1c0 11.9-10.1 21.4-22.6 21.4-12.6 0-22.6-9.5-22.6-21.4 0-12 10.1-21.6 22.6-21.6 12.5-.1 22.6 9.6 22.6 21.6M154.8 30c0-8-5.6-15-13.9-15h-11.5v30.3h11.5c8.3 0 13.9-7.3 13.9-15.3m15.5 0c0 17.1-12.1 28.8-29.1 28.8h-24.6c-1.2 0-2.1-.9-2.1-2V3.4c0-1.1.9-2 2.1-2h24.6c17.1.1 29.1 11.5 29.1 28.6M194.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4 0 4.7 3.7 8.4 8.3 8.4M192.2 17c4.9 0 8.8 1.8 10.5 4.3v-1.2c0-1.1.9-1.9 1.9-1.9H215c1.1 0 1.9.8 1.9 1.9v36.8c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-1.7 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6s10-21.4 20.4-21.4M241.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4 0 4.7 3.7 8.4 8.3 8.4M238.9 17c5 0 8.9 1.9 10.7 4.1V3.4c0-1.1.9-1.9 1.9-1.9H262c1.1 0 1.9.8 1.9 1.9V57c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-2.1 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6S228.7 17 238.9 17M288.4 46.9c4.6 0 8.3-3.8 8.3-8.4s-3.6-8.4-8.3-8.4c-4.6 0-8.3 3.8-8.3 8.4.1 4.7 3.7 8.4 8.3 8.4M286 17c5 0 8.9 1.9 10.7 4.1V3.4c0-1.1.9-1.9 1.9-1.9H309c1.1 0 1.9.8 1.9 1.9V57c0 1.1-.8 1.9-1.9 1.9h-10.3c-1.1 0-1.9-.8-1.9-1.9v-1.2c-2.1 2.5-5.7 4.3-10.6 4.3-10.4 0-20.4-8.3-20.4-21.6S275.7 17 286 17M345.5 64.7c-2.6 8.6-8.6 13.4-18 13.4-5.1 0-10.1-1.7-13.3-4.5-.5-.5-.8-1.1-.8-1.7 0-.5.2-1.1.7-1.7l3.9-5.9c.6-.8 1.5-.9 1.7-.9.9 0 1.3.2 2.1.8 1.2.8 2.9 1.8 4.8 1.8 1.6 0 3.7-.7 4.5-3.1l1.3-4.1H326c-1.3 0-2.1-.9-2.5-2L313 21.5c-.2-.9-.3-1.4-.3-1.7 0-.8.6-1.5 1.7-1.5h12.4c1.1 0 1.7 1 2 2l6.9 25.4h.5l5.5-25.4c.2-1 .9-2 2-2h12.6c1.2 0 1.7.7 1.7 1.5 0 .3-.1.8-.3 1.7l-12.2 43.2M49.7 50.9c-5 6.9-13.2 9.2-20.5 9.2C12.4 60.1 0 47.6 0 30.2.1 13.5 13.5.2 31 .2c13 0 23.4 5.5 28.1 16 .6 1.2 1 3.2-2.5 3.8l-9.2 1.6c-2.1.4-3.3-1-3.7-1.6-2.7-3.7-7.1-6.2-12.4-6.2-9.2 0-15.7 7-15.7 16.3 0 10.3 7.4 16.3 15.5 16.3 5.4 0 9.8-2 12.7-5.8h-8.1c-1.2 0-2.1-.9-2.1-2v-7.7c0-1.1.9-2 2.1-2h24.7c1.2 0 2.1.9 2.1 2v25.9c0 1.1-.9 2-2.1 2h-8.6c-1.2 0-2.1-.9-2.1-2v-5.9M359.8 0c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm0 14.4c-3.5 0-6.4-2.9-6.4-6.4s2.9-6.4 6.4-6.4 6.4 2.9 6.4 6.4-2.9 6.4-6.4 6.4z"></path><path class="logo-mark-color" d="M361.4 6.5c0-.4-.1-.7-.4-.8-.2-.2-.6-.4-.9-.4h-1.4v2.3h1.4c.4 0 .7-.1.9-.4.2-.2.4-.4.4-.7zm-3.1 5.9h-1.5c-.1 0-.1 0-.2-.1 0-.1-.1-.1-.1-.2V3.8c0-.1 0-.1.1-.2.1 0 .1-.1.2-.1h3.3c1.1 0 1.9.2 2.5.8s.9 1.3.9 2.1c0 .6-.1 1.1-.5 1.5-.4.5-.7.8-1.2 1.1l1.9 2.9c.1.1.1.2 0 .4 0 .1-.1.1-.2.1H362c-.1 0-.2 0-.4-.1-.1 0-.1-.1-.2-.2l-1.6-2.7h-1.2V12c0 .1 0 .1-.1.2s-.1.2-.2.2z"></path></svg>
    &nbsp;
  </a>
</nav>

<nav class="navbar navbar-top navbar-expand-md navbar-light bg-white">
  <a class="navbar-brand font-weight-bold" href="http://localhost:4000/engineering/" title="GoDaddy Engineering">
    GoDaddy Engineering
  </a>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#topnav" aria-controls="navbarTogglerDemo02" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>

  <div class="collapse navbar-collapse" id="topnav">
    <ul class="navbar-nav ml-auto">
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/featured-projects/" title="Featured Projects">
          Featured Projects
        </a>
      </li>
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/blog-posts/" title="Blog Posts">
          Blog Posts
        </a>
      </li>
      
      
      
      <li class="nav-item">
        <a class="nav-link font-weight-bold" href="http://localhost:4000/engineering/code-of-conduct/" title="Code of Conduct">
          Code of Conduct
        </a>
      </li>
      
      
      <li class="nav-item">
        <a class="nav-link btn btn-primary text-white font-weight-bold px-3" href="https://careers.godaddy.com/?source=APPLICANT_SOURCE-3-118&utm_source=godaddy-oss" title="Work at GoDaddy">
          Join us!
        </a>
      </li
    </ul>
  </div>
</nav>





<div class="container text-line-height-2x pt-3">
  <h1 class="mb-3 text-line-height-1-5-em">
    Dynamic Configuration for Node.js Applications
  </h1>

  <p>Software systems that use dynamic configuration have the ability to change their configuration at runtime. The benefits of this pattern are vast and not altogether obvious. At GoDaddy, we use dynamic configuration in many of our Node.js applications to implement authorization, feature flags, and A/B tests, in addition to normal application configuration. Read on to learn more about dynamic configuration, its many benefits, and how we’ve implemented it at GoDaddy using an in-house open source library called <a href="https://github.com/godaddy/node-flipr">flipr</a>.</p>

<h3 id="different-flavors-of-dynamic-configuration">Different Flavors of Dynamic Configuration</h3>

<p>Runtime configuration changes fall into two categories.</p>

<ul>
  <li>Application reads and uses new configuration data from an outside source</li>
  <li>A catalyst changes the application’s existing configuration</li>
</ul>

<p>When the term dynamic configuration is thrown around it is often in reference to the first category. Reading configuration changes in real-time from an outside source is a useful behavior in software systems, especially in today’s distributed architectures. To achieve the true power of dynamic configuration, you must embrace the second category as well, which assumes that configuration data contains multiple values for a single data point. At runtime, the application calculates a single value from the multiple values, usually based on some outside entity that interacts with the system. A software system that handles both categories using dynamic configuration can achieve:</p>

<ul>
  <li>Complex authorization rules</li>
  <li>Safe, incremental releases using feature flags</li>
  <li>A/B tests</li>
  <li>Service discovery</li>
  <li>Dynamic routing</li>
  <li>Custom user experiences</li>
</ul>

<p>And this is far from an exhaustive list. All of these software features boil down to configuration data that changes in response to some catalyst. Consider these three catalysts:</p>

<ul>
  <li><strong>Engineers:</strong> An engineer modifies configuration in a data store and pushes the change to connected systems.</li>
  <li><strong>Environment:</strong> An application’s runtime environment changes, resulting in a configuration change.</li>
  <li><strong>End User</strong>: The end user makes a request to an application and the configuration changes based on the end user’s characteristics.</li>
</ul>

<p>Now let’s re-phrase the behaviors mentioned in the previous section to show how dynamic configuration can solve them:</p>

<ul>
  <li><strong>Authorization:</strong> Authorization logic uses configuration data that changes based on end user characteristics</li>
  <li><strong>Feature flags:</strong> Features wrapped in logic uses configuration data that changes based on end user characteristics or engineers pushing updates</li>
  <li><strong>A/B tests:</strong> Features and metrics wrapped in logic uses configuration data that changes based on end user characteristics</li>
  <li><strong>Service discovery:</strong> Service endpoints are read from configuration data that changes based on engineers pushing updates or changes in the environment</li>
  <li><strong>Dynamic routing:</strong> A reverse proxy uses configuration data that changes based on engineers pushing updates or changes in the environment</li>
  <li><strong>Custom user experiences:</strong> Different user experiences wrapped in logic use configuration data that changes based on end user characteristics</li>
</ul>

<p>Dynamic configuration provides a solid foundation for all of these features. Next we’ll introduce <a href="https://github.com/godaddy/node-flipr">flipr</a> and provide examples of how GoDaddy uses it to solve various problems.</p>

<h3 id="dynamic-configuration-with-flipr">Dynamic Configuration with Flipr</h3>

<p><a href="https://github.com/godaddy/node-flipr">Flipr</a> is a Node.js library for both static and dynamic configuration. It was created back in 2015 when we needed a way to create granular feature flags for one of our applications. At the time there weren’t any existing modules that met our requirements, so we opted to write our own. It’s been used in production since its release and has recently received an ES6 rewrite along with some new features.</p>

<p>Flipr reads configuration data from a source and then exposes that data via a simple interface. Applications retrieve configuration individually by key or all at once. Applications can also define rules and pass input to flipr that make the configuration dynamic.</p>

<p>Let’s start out with a simple static configuration to show off flipr’s components. We’ll use <a href="https://github.com/godaddy/node-flipr-yaml">flipr-yaml</a> as the source, which reads configuration from yaml files that exist alongside application code and provides it to flipr.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="c1"># Exists as a file at ./config.yaml</span>
<span class="c1"># "description" is optional, but documenting your config is a good idea</span>
<span class="c1"># use "value" for static configuration</span>

<span class="na">databaseServer</span><span class="pi">:</span>
  <span class="na">description</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="no">This is the IP of the database server where the app stores its data.</span>
  <span class="na">value</span><span class="pi">:</span> <span class="s">127.0.0.1</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Flipr</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'flipr'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">FliprYaml</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'flipr-yaml'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FliprYaml</span><span class="p">({</span>
  <span class="na">filePath</span><span class="p">:</span> <span class="s1">'./config.yaml'</span>
<span class="p">});</span>
<span class="kd">const</span> <span class="nx">flipr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Flipr</span><span class="p">({</span> <span class="nx">source</span> <span class="p">});</span>

<span class="c1">// Assume that we're inside an async function and thus can use await</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">flipr</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s2">"databaseServer"</span><span class="p">));</span>
<span class="c1">// 127.0.0.1</span>
</code></pre></div></div>

<p>All this code does is define a simple yaml config file, setup flipr to read it, and retrieve the value of the databaseServer config item. An important takeaway from this example is that retrieving configuration from flipr is always an asynchronous action. Even if the source is able to retrieve configuration data synchronously, the interface remains asynchronous for the sake of compatibility.</p>

<p>Let’s look at a simple dynamic example. Remember that we described two types of dynamic configuration: retrieving new configuration and changing existing configuration. We’re going to focus on the latter for this example. Assume that we want to change the databaseServer our application uses depending on a user’s ID.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="c1"># use "values" for dynamic configuration</span>

<span class="na">databaseServer</span><span class="pi">:</span>
  <span class="na">description</span><span class="pi">:</span> <span class="pi">&gt;</span>
    <span class="no">These are the IPs of the database servers where the app stores its data.</span>
  <span class="na">values</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">userId</span><span class="pi">:</span> <span class="s">123</span>       <span class="c1"># this is a rule property</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">10.0.0.1</span>
    <span class="pi">-</span> <span class="na">value</span><span class="pi">:</span> <span class="s">127.0.0.1</span>  <span class="c1"># no rule property, this is the default value</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">Flipr</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'flipr'</span><span class="p">);</span>
<span class="kd">const</span> <span class="nx">FliprYaml</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'flipr-yaml'</span><span class="p">);</span>

<span class="kd">const</span> <span class="nx">rules</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'equal'</span><span class="p">,</span>      <span class="c1">// rule type, determines how rule compares input to rule property.</span>
    <span class="na">input</span><span class="p">:</span> <span class="s1">'id'</span><span class="p">,</span>        <span class="c1">// the object-path of the input to evaluate, i.e. input.id (supports nesting)</span>
    <span class="na">property</span><span class="p">:</span> <span class="s1">'userId'</span><span class="p">,</span> <span class="c1">// the name of the rule property in the config</span>
  <span class="p">}</span>
<span class="p">];</span>
<span class="kd">const</span> <span class="nx">source</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FliprYaml</span><span class="p">({</span>
  <span class="na">filePath</span><span class="p">:</span> <span class="s1">'./config.yaml'</span>
<span class="p">});</span>
<span class="kd">const</span> <span class="nx">flipr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Flipr</span><span class="p">({</span> <span class="nx">source</span> <span class="p">});</span>

<span class="kd">const</span> <span class="nx">userA</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">id</span><span class="p">:</span> <span class="mi">123</span><span class="p">,</span>
<span class="p">};</span>
<span class="kd">const</span> <span class="nx">userB</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">id</span><span class="p">:</span> <span class="mi">456</span><span class="p">,</span>
<span class="p">};</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">flipr</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s2">"databaseServer"</span><span class="p">,</span> <span class="nx">userA</span><span class="p">));</span>
<span class="c1">// 10.0.0.1</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="kr">await</span> <span class="nx">flipr</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s2">"databaseServer"</span><span class="p">,</span> <span class="nx">userB</span><span class="p">));</span>
<span class="c1">// 127.0.0.1</span>
</code></pre></div></div>

<p>This is a contrived example, but it’s sufficient to show that flipr can return different config values by evaluating some input against a rule. The database server for userA is 10.0.0.1 because its <code class="highlighter-rouge">id</code> property equals the value defined in the config’s <code class="highlighter-rouge">userId</code> rule property. Whereas userB is 127.0.0.1 because it doesn’t match any of the <code class="highlighter-rouge">userId</code> values in the config and thus uses the default value.</p>

<h3 id="using-flipr-for-common-application-needs">Using Flipr for Common Application Needs</h3>

<p>Remember that applications can use dynamic configuration to implement many interesting behaviors. Let’s see that in action with flipr. The following examples exclude some of the boilerplate code to keep things concise.</p>

<h5 id="authorization">Authorization</h5>

<p>Authorization is usually a simple boolean decision: does an identity have access to do something, yes or no? Flipr allows you to declaratively define authorization points in your config and use rules to make those decisions.</p>

<p>Assume that we have an application that allows users to post comments, but only allows moderators to delete comments. Moderators are users that have a userType of <code class="highlighter-rouge">2</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">canDeleteComments</span>
  <span class="s">values</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">isModerator</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">value</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">value</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rules</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'equal'</span><span class="p">,</span>
    <span class="na">input</span><span class="p">:</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">user</span><span class="p">.</span><span class="nx">userType</span> <span class="o">===</span> <span class="mi">2</span><span class="p">,</span>
    <span class="na">property</span><span class="p">:</span> <span class="s1">'isModerator'</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">];</span>
<span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="kr">await</span> <span class="nx">flipr</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s1">'canDeleteComments'</span><span class="p">,</span> <span class="nx">user</span><span class="p">))</span> <span class="p">{</span>
  <span class="kr">await</span> <span class="nx">deleteComment</span><span class="p">(</span><span class="nx">commentId</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
  <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s1">'You are not authorized to delete comments.'</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>Alternatively, you could also implement the equal rule like this.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">canDeleteComments</span>
  <span class="s">values</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">userType</span><span class="pi">:</span> <span class="s">2</span>
      <span class="na">value</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">value</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rules</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'equal'</span><span class="p">,</span>
    <span class="na">input</span><span class="p">:</span> <span class="s1">'userType'</span><span class="p">,</span>
    <span class="na">property</span><span class="p">:</span> <span class="s1">'userType'</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">];</span>
</code></pre></div></div>

<p>Rules and inputs are very flexible, it’s up to you to determine how best to define them. Just remember, as a rule of thumb, it’s generally better to define each authorization point in your configuration than to create a configuration item such as “isAdmin” and use that to make authorization decisions in your code.</p>

<h5 id="feature-flags">Feature Flags</h5>

<p>Feature flags are really just authorization decisions with a fancy name. Their purpose is to enable or disable features in your application. Using flipr, your feature flags can respond differently depending on the current user context. This is handy for rolling out features incrementally to a small set of users before opening the gates to everyone. You can also disable features entirely in certain environments, e.g. disable features in production until they’re finished so that code can continually be to pushed to master without impacting users.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">someNewFeature</span>
  <span class="s">values</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">locations</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">AZ</span>
      <span class="pi">-</span> <span class="s">CA</span>
      <span class="na">value</span><span class="pi">:</span> <span class="no">true</span>
    <span class="pi">-</span> <span class="na">value</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rules</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'list'</span><span class="p">,</span>
    <span class="na">input</span><span class="p">:</span> <span class="s1">'location'</span><span class="p">,</span>
    <span class="na">property</span><span class="p">:</span> <span class="s1">'locations'</span><span class="p">,</span>
  <span class="p">}</span>
<span class="p">];</span>
<span class="c1">// ...</span>
<span class="k">if</span> <span class="p">(</span><span class="kr">await</span> <span class="nx">flipr</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s1">'someNewFeature'</span><span class="p">,</span> <span class="nx">user</span><span class="p">))</span> <span class="p">{</span>
  <span class="nx">loadSomeNewFeature</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</code></pre></div></div>

<p>Here we’ve enabled some new feature for users in Arizona and California and disabled it for everyone else.</p>

<h5 id="ab-tests">A/B Tests</h5>

<p>At the risk of sounding like a broken record, A/B tests are really just feature flags with a fancy name. Their purpose is to enable different behaviors for different groups of users, record metrics based on how those users respond, and then compare the results. Flipr isn’t a complete A/B test tool by any means, but you can get pretty far with just a little extra code.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">purchasePathTest</span>
  <span class="s">values</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">testGroup</span><span class="pi">:</span> <span class="s">a</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">one-click</span>
    <span class="pi">-</span> <span class="na">testGroup</span><span class="pi">:</span> <span class="s">b</span>
      <span class="na">value</span><span class="pi">:</span> <span class="s">new-checkout</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">rules</span> <span class="o">=</span> <span class="p">[</span>
  <span class="p">{</span>
    <span class="na">type</span><span class="p">:</span> <span class="s1">'equal'</span><span class="p">,</span>
    <span class="c1">// idToPercent creates a hash of the user id and the test id, then converts that to a percentage</span>
    <span class="na">input</span><span class="p">:</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">idToPercent</span><span class="p">(</span><span class="nx">user</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="s1">'purchasePathTest'</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mf">0.5</span> <span class="p">?</span> <span class="s1">'a'</span> <span class="p">:</span> <span class="s1">'b'</span><span class="p">,</span>
    <span class="na">property</span><span class="p">:</span> <span class="s1">'testGroup'</span><span class="p">,</span>
  <span class="p">},</span>
<span class="p">];</span>

<span class="c1">// ...</span>

<span class="c1">// metric logs would contain the user context, which would contain the abTests</span>
<span class="nx">user</span><span class="p">.</span><span class="nx">abTests</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="kr">await</span> <span class="nx">flipr</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s1">'purchasePathTest'</span><span class="p">,</span> <span class="nx">user</span><span class="p">));</span>

<span class="c1">// ...</span>

<span class="c1">// display different UX based on test group</span>
<span class="k">switch</span><span class="p">(</span><span class="kr">await</span> <span class="nx">flipr</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s1">'purchasePathTest'</span><span class="p">,</span> <span class="nx">user</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">case</span> <span class="s1">'one-click'</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">renderOneClickPurchasePath</span><span class="p">();</span>
  <span class="k">case</span> <span class="s1">'new-checkout'</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">renderNewCheckoutPath</span><span class="p">();</span>
  <span class="nl">default</span><span class="p">:</span>
    <span class="k">return</span> <span class="nx">renderCheckoutPath</span><span class="p">();</span>
<span class="p">}</span>
<span class="c1">// ...</span>
</code></pre></div></div>

<h5 id="service-discovery">Service Discovery</h5>

<p>Most of the examples thus far have relied on existing configuration changing its values based on some catalyst. Service discovery relies more on receiving and using new configuration data. To achieve this, you must use a flipr source that can automatically receive updates from an external data store. At one point flipr had an <a href="https://coreos.com/etcd/">etcd</a> source that implemented this behavior, but we no longer maintain it. You can check out the code <a href="https://github.com/godaddy/node-flipr-etcd">here</a> for inspiration, there’s not much to it (note: it’s targeting flipr’s v1 interface).</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="kr">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="kr">await</span> <span class="nx">flipr</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(</span><span class="s1">'someServiceUrl'</span><span class="p">));</span>
<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">json</span><span class="p">());</span>
</code></pre></div></div>

<p>When flipr receives new configuration, <code class="highlighter-rouge">someServiceUrl</code> changes, and the code above starts directing traffic to a new endpoint.</p>

<h5 id="other-uses">Other Uses</h5>

<p>Dynamic configuration is a good choice for any application that would benefit from defining logical decisions external to itself. Whether that configuration should exist alongside your application code in separate files, or in some external data source depends on your use case. When looking for places to implement dynamic configuration, try asking yourself:</p>

<ul>
  <li>Would I benefit from having this logic maintained and documented in a centralized location?</li>
  <li>Would I benefit from being able to change this logic without re-deploying my application?</li>
  <li>Would I benefit from being able to change this logic based on the current context or the runtime environment?</li>
</ul>

<h3 id="flipr-best-practices">Flipr Best Practices</h3>

<p>Flipr’s flexibility can act against you if used incorrectly. Here are some best practices we use at GoDaddy to keep our code and configuration maintainable.</p>

<ul>
  <li>One instance of flipr per source per process. This takes full advantage of flipr’s internal caching.</li>
  <li>Prefer configuration files to exist alongside application code and validate configuration in unit tests.
    <ul>
      <li>This depends a lot on your CICD pipeline and deployment strategy. If you are able to quickly build, test, and deploy your application, having the configuration files coupled to the application code gives you built in auditing, versioning, and easy rollback thanks to source control. However, if your CICD pipeline is slow, or you need config changes to immediately propagate to live applications, then you’ll want your configuration data to exist in a source capable of live updates, e.g. <a href="https://coreos.com/etcd/">etcd</a>.</li>
    </ul>
  </li>
  <li>Create separate configuration files by environment and purpose, e.g. dev/test/prod and feature flags/authorization/ab tests.</li>
  <li>Document your configuration. Flipr’s schema is metadata friendly.</li>
  <li>Clean up stale configuration. This is especially important with feature flags, which tend to go stale quickly.
    <ul>
      <li>Tip: Use “sunset tests”, which are unit tests that fail after a certain date if some targeted configuration still exists.</li>
    </ul>
  </li>
</ul>

<h3 id="related-resources">Related Resources</h3>

<ul>
  <li><a href="https://blog.twitter.com/engineering/en_us/topics/infrastructure/2018/dynamic-configuration-at-twitter.html">Dynamic configuration at Twitter</a></li>
  <li><a href="https://github.com/godaddy/node-flipr">flipr</a>, <a href="https://github.com/godaddy/node-flipr-yaml">flipr-yaml</a>, <a href="https://github.com/godaddy/node-flipr-validation">flipr-validation</a>, <a href="https://github.com/godaddy/node-flipr-etcd">flipr-etcd</a></li>
</ul>


  <div class="text-center mb-1">
  <div class="addthis_inline_share_toolbox"></div>
</div>

  

<hr>

<div class="authors">
  <h4 class="mb-3">
  
  Author
  
</h4>

  <div class="row">
    
    <div class="col-12">
      <div class="author mb-3">
        <a href="https://github.com/gshively11">
          <img class="rounded mr-2" src="https://avatars.githubusercontent.com/gshively11" alt="Grant Shively" width="64">
          <span class="author-details">
            <h6>Grant Shively</h6>
            
          </span>
        </a>
      </div>
    </div>
    
  </div>
</div>

</div>

<footer class="page-footer text-light bg-theme-grey-dark">
    <div class="container py-3">
      <div class="row">
        <div class="col-12 col-md-6">
          <h5 class="text-white text-font-headline">
            GoDaddy Engineering
          </h5>
          <p>
            At GoDaddy we build next-generation experiences that empower the world's small business owners to start and grow their independent ventures.

            <a href="https://careers.godaddy.com/?source=APPLICANT_SOURCE-3-118&utm_source=godaddy-oss" title="Work at GoDaddy">
              Join us!
            </a>
          </p>
        </div>
        <div class="col-12 col-md-4 offset-md-2">
          <h5 class="text-white text-font-headline">
            On the web
          </h5>
          <ul class="list-unstyled mb-0">
  
  
  <li>
    <a class="text-light" href="https://github.com/godaddy" title="godaddy on GitHub">
      GitHub
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://twitter.com/GodaddyOSS" title="GodaddyOSS on Twitter">
      Twitter
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://dribbble.com/GoDaddy" title="GoDaddy on Dribbble">
      Dribbble
    </a>
  </li>
  
  
  
  <li>
    <a class="text-light" href="https://www.facebook.com/GoDaddy" title="GoDaddy on Facebook">
      Facebook
    </a>
  </li>
  
  
</ul>

        </div>
      </div>
    </div>
    <div class="footer-copyright bg-extra-dark text-center text-light font-weight-light py-3">
      <small>
        Copyright © 1999 - 2018 GoDaddy Operating Company, LLC. All Rights Reserved.

      </small>
    </div>
  </footer>
  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>


<script async src="https://www.google-analytics.com/analytics.js"></script>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/autotrack/2.4.1/autotrack.js"></script>
<script>
  window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
  ga('create', 'UA-37178807-20', 'auto');
  ga('require', 'outboundLinkTracker');
  ga('send', 'pageview');
</script>



<script async src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5b039a09ed801a5d"></script>






</body>
</html>

